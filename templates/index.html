<!doctype html>
<html>
    <head>
        <title>Paint Survey</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" type="text/css" href="static/main.css" />
        <link rel="stylesheet" type="text/css" href="static/owl-carousel/owl.carousel.css" />
        <link rel="stylesheet" href="static/owl-carousel/owl.theme.css" />
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="static/jquery.validate.min.js"></script>
        <script src="static/owl-carousel/owl.carousel.js"></script>
    </head>
    <body>
        <h1 id='app-title'>Paint Survey</h1>
        <div id='owl-carousel' class='owl-carousel'>
            <div id='page-left-3'>
                <h2>Production Rates Defaults</h2>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <form id='form-production-rates'>
                          <div class='form-row'>
                            <label>Ceilings</label>
                            <select id='select-ceiling-prod-rate'>
                              <option value="20">1 Vinyl Matt (20)</option>
                              <option value="10">2 Vinyl Matt (10)</option>
                              <option value="9">2 Eggshell (9)</option>
                            </select>
                          </div>
                          <div class='form-row'>
                            <label>Walls</label>
                            <select id='select-wall-prod-rate'>
                              <option value="4.5">Wallpaper (4.5)</option>
                              <option value="10">2 Vinyl Matt (10)</option>
                              <option value="9">2 Eggshell (9)</option>
                            </select>
                          </div>
                          <div class='form-row'>
                            <label>Door Area</label>
                            <select id='select-door-area-prod-rate'>
                              <option value="4">General surface (4)</option>
                              <option value="3.5">Glazed med pane (3.5)</option>
                              <option value="2.5">Glazed small pane (2.5)</option>
                            </select>
                          </div>
                          <div class='form-row'>
                            <label>Door Frame</label>
                            <select id='select-door-frame-prod-rate'>
                              <option value="4">General surface (4)</option>
                              <option value="3.5">Glazed med pane (3.5)</option>
                              <option value="2.5">Glazed small pane (2.5)</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Windows</label>
                            <select id='select-window-prod-rate'>
                              <option value="5">Large pane (5)</option>
                              <option value="4">Med pane (4)</option>
                              <option value="3">Small pane (3)</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Radiators</label>
                            <select id='select-radiator-prod-rate'>
                              <option value="4">Panel (4)</option>
                              <option value="2">Column (2)</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Skirtings</label>
                            <select id='select-skirting-prod-rate'>
                              <option value="15">100 Girth (15)</option>
                              <option value="12">150 Girth (12)</option>
                              <option value="10">300 Girth (10)</option>
                            </select>
                          </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id='page-left-2'>
                <h2>Room Settings Defaults</h2>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                      <form id='form-production-rates'>
                        <div class='form-row'>
                          <label>Room height</label>
                          <input id='default-room-height' type='number' step='any' min='0' placeholder='enter height' class='decimal'/>
                        </div>
                        <div class='form-row'>  
                          <label>Door width</label>
                          <input id='default-door-width' type='number' step='any' min='0' placeholder='enter width' class='decimal' />
                        </div>
                        <div class='form-row'>  
                          <label>Door height</label>
                          <input id='default-door-height' type='number' step='any' min='0' placeholder='enter height' class='decimal'/>
                        </div>
                        <div class='form-row'>  
                          <label>Window width</label>
                          <input id='default-window-width' type='number' step='any' min='0' placeholder='enter width' class='decimal'/>
                        </div>
                        <div class='form-row'>  
                          <label>Window height</label>
                          <input id='default-window-height' type='number' step='any' min='0' placeholder='enter height' class='decimal'/>
                        </div>
                        <div class='form-row'>  
                          <label>Radiator width</label>
                          <input id='default-radiator-width' type='number' step='any' min='0' placeholder='enter width' class='decimal'/>
                        </div>
                        <div class='form-row'>  
                          <label>Radiator height</label>
                          <input id='default-radiator-height' type='number' step='any' min='0' placeholder='enter height' class='decimal'/>
                        </div>
                      </form>
                    </div>
                </div>
            </div>
            <div id='page-left-1'>
                <h2>Projects</h2>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <div class='form-row'>  
                            <label>Select Existing</label>
                            <select id='select-project'>
                                {% for p in projects %}
                                <option value='{{ p.key.urlsafe() }}'>{{ p.title }} {{ p.date_created }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input id='btn-select-project' type='button' value='Confirm'/>
                        <div class='form-row'>
                            <label>Create New</label>
                            <input id='new-project-title' type='text' placeholder='Enter Project Title'/>
                        </div>
                        <input id='btn-create-project' type='button' value='Confirm'/>
                    </div>
                </div>
            </div>
            <div id='page-room-1' class='page-room'>
                <h2 class="room-title" data-room-number="1">Room 1</h2>
                <div class='pageContentOuter'>
                  <div class='pageContent'>
                      <div class='results'>RESULTS</div>
                      <div class='colLeft'>
                          <form class='room-form'> 
                              <div class='group-label'>
                                  <span>Room</span>
                              </div>
                              <div class='form-group'>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>L</div>
                                          <input id='room-length' name='room-length' type='number' step='any' min='0' placeholder='enter length' class='form-control required decimal'>
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>W</div>
                                          <input id='room-width' name='room-width' type='number' step='any' min='0' placeholder='enter width' class='form-control required decimal'>
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>H</div>
                                          <input id='room-height' name='room-height' type='number' step='any' min='0'  placeholder='enter height' class='form-control required decimal'>
                                      </div>
                                  </div>
                              </div>

                              <div class='group-label'>
                                  <span>Door</span>
                              </div>
                              <div class='form-group'>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>#</div>
                                          <input id='door-qty' name='door-qty' type='number' step='1' min='0' placeholder='enter quantity' class='form-control required integer' value='1'>
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>W</div>
                                          <input id='door-width' name='door-width' type='number' step='any' min='0' placeholder='enter width' class='form-control required decimal'>
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>H</div>
                                          <input id='door-height' name='door-height' type='number' step='any' min='0' placeholder='enter width'  class='form-control required decimal'>
                                      </div>
                                  </div>
                              </div>

                              <div class='group-label'>
                                  <span>Window</span>
                              </div>
                              <div class='form-group'>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>#</div>
                                          <input id='window-qty' name='window-qty' type='number' step='1' min='0' value='1' placeholder='enter quantity' class='form-control required integer' value='1' />
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>W</div>
                                          <input id='window-width' name='window-width' type='number' step='any' min='0' placeholder='enter width' class='form-control required decimal'/>
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>H</div>
                                          <input id='window-height' name='window-height' type='number' step='any' min='0' placeholder='enter height' class='form-control required decimal'/>
                                      </div>
                                  </div>
                              </div>

                              <div class='group-label'>
                                  <span>Radiator</span>
                              </div>
                              <div class='formRow'>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>#</div>
                                          <input id='radiator-qty' name='radiator-qty' type='number' step='any' min='0' placeholder='enter quantity' value='1' class='form-control required integer' value='1' />
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>W</div>
                                          <input id='radiator-width' name='radiator-width' type='number' step='any' min='0' placeholder='enter width' value='1.50' class='form-control required decimal'/>
                                      </div>
                                  </div>
                                  <div class='input-group'>
                                      <div class="input-group-inner">
                                          <div class='control-label'>H</div>
                                          <input id='radiator-height' name='radiator-height' type='number' step='any' min='0' placeholder='enter height' value='0.7' class='form-control required decimal' />
                                      </div>
                                  </div>
                              </div>

                              <input type='button' id='btnCalculate' class='btn-room-calculate' value='Calculate'/>

                          </form>
                      </div>
                    </div>
                </div>
            </div>
        </div>
<script>
    //Global variable to store current project data
    var CURRENT_PROJECT = {};

    //Add the projects to the select list
    function populateProjects(projects){
        $('#select-project').find('option').remove();
        for(var i=0; i<projects.length; i++){
            $('#select-project')
              .append(
                  $('<option></option>')
                    .attr('value',projects[i].id)
                    .text(projects[i].title + ' (' 
                      + projects[i].date_created.split('.')[0]
                        .replace('T',' ') + ')'
                    )
              ); 
        }
    }

    function populateRoomDefaults(){
        {% for key, value in default_room.to_dict().iteritems() if key != 'is_default'%}
        $('#default-{{key.replace("_","-")}}' ).val( {{ value }} );
        {% endfor %}
    }

    function selectProject(){
        $.ajax({
            type: 'POST',
            url: '/getproject',
            data: { project_key: $('#select-project').val() },
            success: function(data){ 
                CURRENT_PROJECT = JSON.parse(data);
                $('#app-title').text('Paint Survey - ' + CURRENT_PROJECT.title);
                alert('Project selected: ' + CURRENT_PROJECT.title ); 
                //TODO: fetch and populate the room data according to whichever project is selected
            }
        });
    }

    function createProject(){
        if($('#new-project-title').val().match(/\S/g)){
            $.ajax({
                type: 'POST',
                url: '/createproject',
                data: { projectTitle: $('#new-project-title').val() },
                success: function(data){ 
                  alert('Project created successfully.'); 
                  populateProjects(JSON.parse(data));

                  //selectProject();
                }
            });
        }else{
            alert('Project title can not be blank!');
        }
    }

    function populateRoomWithDefaults(){
        $('#room-height').val(parseFloat($('#default-room-height').val()).toFixed(2));
        $('#door-qty').val(1);
        $('#door-width').val(parseFloat($('#default-door-width').val()).toFixed(2));
        $('#door-height').val(parseFloat($('#default-door-height').val()).toFixed(2));
        $('#window-qty').val(1);
        $('#window-width').val(parseFloat($('#default-window-width').val()).toFixed(2));
        $('#window-height').val(parseFloat($('#default-window-height').val()).toFixed(2));
        $('#radiator-qty').val(1);
        $('#radiator-width').val(parseFloat($('#default-radiator-width').val()).toFixed(2));
        $('#radiator-height').val(parseFloat($('#default-radiator-height').val()).toFixed(2));
    }

    function calculateWorkForRoom(event){
        var page = $(event.target).closest('.pageContent');
        
        var rmLength =      parseFloat(page.find('#room-length:first').val());
        var rmWidth =       parseFloat(page.find('#room-width:first').val());
        var rmHeight =      parseFloat(page.find('#room-height:first').val());
        var doorQty =       parseFloat(page.find('#door-qty:first').val());
        var doorWidth =     parseFloat(page.find('#door-width:first').val());
        var doorHeight =    parseFloat(page.find('#door-height:first').val());
        var windowQty =     parseFloat(page.find('#window-qty:first').val());
        var windowWidth =   parseFloat(page.find('#window-width:first').val());
        var windowHeight =  parseFloat(page.find('#window-height:first').val());
        var radiatorQty =     parseFloat(page.find('#radiator-qty:first').val());
        var radiatorWidth =   parseFloat(page.find('#radiator-width:first').val());
        var radiatorHeight =  parseFloat(page.find('#radiator-height:first').val());
  
        var doorSpace =     doorQty * doorWidth * doorHeight;
        var doorFrame =     (doorHeight * 2 + doorWidth) * doorQty;
        var windowSpace =   windowQty * windowWidth * windowHeight;
        var ceilingSpace =  (rmLength * rmWidth); 
        var wallSpace =     (rmLength + rmWidth) * 2 * rmHeight - doorSpace - windowSpace; 
        var skirtingSpace = (rmLength + rmWidth) * 2 - (doorWidth * doorQty);
        var radiatorSpace = radiatorQty * radiatorWidth * radiatorHeight;

        var tableData = [
            { title: 'DOOR AREA',   amount: doorSpace,       units: 'm2', hours: doorSpace / parseInt($('#select-door-area-prod-rate').val()) },
            { title: 'DOOR FRAME',  amount: doorFrame,       units: 'm',  hours: doorFrame / parseInt($('#select-door-frame-prod-rate').val()) },
            { title: 'WINDOW',      amount: windowSpace,     units: 'm2', hours: windowSpace / parseInt($('#select-window-prod-rate').val()) },
            { title: 'CEILING',     amount: ceilingSpace,    units: 'm2', hours: ceilingSpace / parseInt($('#select-ceiling-prod-rate').val()) },
            { title: 'WALL',        amount: wallSpace,       units: 'm2', hours: wallSpace / parseInt($('#select-wall-prod-rate').val()) },
            { title: 'SKIRTING',    amount: skirtingSpace,   units: 'm2', hours: skirtingSpace / parseInt($('#select-skirting-prod-rate').val()) },
            { title: 'RADIATOR',    amount: radiatorSpace,   units: 'm2', hours: radiatorSpace / parseInt($('#select-radiator-prod-rate').val()) }
        ];

        page.find('.results:first').html(buildResultsTable(tableData));

        window.scrollTo(0,0);
    }

    function buildResultsTable(tableData){
        var results = '<table><tr><th>Part</th><th>Amount</th><th></th><th>Hours</th></tr>';
        var totalHours = 0;
        
        for (i = 0; i < tableData.length; ++i) {
            obj = tableData[i];
            results += '<tr>';
            for (var key in obj){
                if (obj.hasOwnProperty(key)) {
                    var val = 0;
                    var cssClass = 'class="tdRightAlign"';
                    if(key == 'amount' ){
                        val = roundAndFix(obj[key], 2);
                    }else if(key == 'hours'){
                        val = roundAndFix(obj[key], 2);
                        totalHours += parseFloat(val);
                    }else{
                        val = obj[key];
                        cssClass = '';
                    }
                    results += '<td ' + cssClass + '>' + val + '</td>';
                }
            }
            results += '</tr>';
        }

        results += '<tr class="rowTotalHours"><td>TOTAL:</td><td></td><td></td><td class="tdRightAlign">' + totalHours.toFixed(2) + '</td></tr>';
        results += '</table>';
        return results;
    }

    function initOwlCarousel(){
        $("#owl-carousel").owlCarousel(
            { 
                navigation : true, // Show next and prev buttons
                slideSpeed : 300,
                paginationSpeed : 400,
                singleItem: true,
                afterInit : function(elem){
                  var that = this;
                  that.owlControls.prependTo(elem);
                  this.jumpTo(2);
                }
            }
        );
    }

    function roundAndFix (number, precision) {
        var multiplier = Math.pow (10, precision);
        var result = Math.round (number * multiplier) / multiplier;
        return result.toFixed(precision);
    }

    function allowOnlyDecimalInput(event){

        // Allow: backspace, delete, tab, escape, enter, ctrl+A
        if ($.inArray(event.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
             // Allow: Ctrl+A
            (event.keyCode == 65 && event.ctrlKey === true) || 
             // Allow: home, end, left, right
            (event.keyCode >= 35 && event.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }

        //If not number or decimal point, prevent.
        if(/[^0-9]/.test(String.fromCharCode(event.keyCode))
          && event.keyCode != 190 ){
            event.preventDefault();
            return;
        };

        //if already decimal point, prevent.
        if(event.keyCode == 190 && /\./.test(this.value)) {
            event.preventDefault();
            return;
        }
    }

    function allowOnlyIntegerInput(event){
        // Allow: backspace, delete, tab, escape, enter, ctrl+A
        if ($.inArray(event.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
             // Allow: Ctrl+A
            (event.keyCode == 65 && event.ctrlKey === true) || 
             // Allow: home, end, left, right
            (event.keyCode >= 35 && event.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }

        //If not number, prevent
        if(/[0-9]/.test(String.fromCharCode(event.keyCode))) return;

        event.preventDefault();  
    }

    $(document).ready(function() {
      
        initOwlCarousel();
        populateRoomDefaults();
        populateRoomWithDefaults();

        $('.integer').keydown( allowOnlyIntegerInput ); 
        $('.decimal').keydown( allowOnlyDecimalInput );

        $( ".decimal" ).bind('blur', function() {
            //Enforce 2 decimal places.
            if(this.value.trim() == '.') this.value = '0.00';
            if(this.value.length >= 1 && parseFloat(this.value) > 0){
                this.value = parseFloat(this.value).toFixed(2);
            }else{
                this.value = '';
            }
        });

        $('#btn-select-project').click( selectProject );
        $('#btn-create-project').click( createProject );

        $('.btn-room-calculate').click( 
            function(){
                var options = {
                    errorPlacement: function(error, element) {
                        error.insertAfter(element.closest('.input-group'));
                    }
                };
                if($(event.target).closest('.room-form').validate(options).form()){
                    calculateWorkForRoom(event); 
                }
            }
        );

        $(".owl-item").bind("touchstart click", function (event) {
            if(event.target.tagName.toLowerCase() != 'input'){
                $(':focus').blur()
            }
        });
    });
</script>
    </body>
</html>