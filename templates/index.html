<!doctype html>
<html>
    <head>
        <title>Paint Survey</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" type="text/css" href="static/main.css" />
        <link rel="stylesheet" type="text/css" href="static/owl-carousel/owl.carousel.css" />
        <link rel="stylesheet" href="static/owl-carousel/owl.theme.css" />
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="static/jquery.validate.min.js"></script>
        <script src="static/owl-carousel/owl.carousel.js"></script>
    </head>
    <body>
        <h1 id='app-title'>Paint Survey</h1>
        <div id='owl-carousel' class='owl-carousel'>
            <div id='page-specification'>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                            
                        <form id='form-edit-spec'>
                            <div class='input-group'>
                                <h2>Edit Specification
                                <button type='button' id='btn-add-spec-item'>
                                    <svg height='30' width='30'>
                                        <circle cx='15' cy='15' r='15' fill='blue' />
                                        <polygon points='12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12' fill='white' />
                                    </svg>
                                </button>
                                </h2>
                                <div class='input-block hidden'>
                                    <input type='hidden' class='spec-paint-key'/>
                                    <div class='form-row group'>
                                        <label>Item Name</label>
                                        <input class='spec-item-name' type='text' placeholder='item name'/>
                                        <button type='button' class='btn-remove-row'>
                                            <svg height='30' width='30'>
                                                <circle cx='15' cy='15' r='15' fill='red' />
                                                <polygon points='6,12 24,12 24,18 6,18 6,12' fill='white' />
                                            </svg>
                                        </button>
                                    </div>
                                    <div class='form-row'>
                                        <label>Production Rate</label>
                                        <input class='spec-item-rate decimal' type='number' step='any' min='0' placeholder='rate'/>
                                    </div>
                                </div>
                            </div>
                            <button type='button' class='btn-save'>Save</button>
                            <button type='button' class='btn-cancel'>Cancel</button>
                        </form>

                        <form id='form-view-spec'>
                            <h2>Specification</h2>
                            <div class='form-row spec-item-block hidden'>
                                <label class='spec-item-title'>Ceilings</label>
                                <div class="dropdown">
                                    <button class="dropdown-btn dropdown-toggle" type="button" data-toggle="dropdown">
                                        <span class='dropdown-text'>Dropdown</span>
                                        <input type='hidden' id='select-ceiling-prod-rate' class='dropdown-value'/>
                                        <span class="caret"></span>
                                    </button>
                                    <ul class='dropdown-menu' role='menu'></ul>
                                    <button type='button' class='btn-edit-spec'></button>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <div id='page-room-defaults'>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <h2>Default Room Settings</h2>
                        <form id='form-room-defaults'>
                            <div class='form-row'>
                                <label>Room height</label>
                                <input id='default-room-height' type='number' step='any' min='0' placeholder='enter height' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Door width</label>
                                <input id='default-door-width' type='number' step='any' min='0' placeholder='enter width' class='decimal round-corners-input' />
                            </div>
                            <div class='form-row'>  
                                <label>Door height</label>
                                <input id='default-door-height' type='number' step='any' min='0' placeholder='enter height' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Window width</label>
                                <input id='default-window-width' type='number' step='any' min='0' placeholder='enter width' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Window height</label>
                                <input id='default-window-height' type='number' step='any' min='0' placeholder='enter height' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Radiator width</label>
                                <input id='default-radiator-width' type='number' step='any' min='0' placeholder='enter width' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Radiator height</label>
                                <input id='default-radiator-height' type='number' step='any' min='0' placeholder='enter height' class='decimal round-corners-input'/>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id='page-left-1'>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <h2>Projects</h2>
                        <div class='form-row'>  
                            <label>Select Existing</label>
                            <select id='select-project'>
                                {% for p in projects %}
                                <option value='{{ p.key.urlsafe() }}'>{{ p.title }} {{ p.date_created }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input id='btn-select-project' type='button' value='Confirm'/>
                        <div class='form-row'>
                            <label>Create New</label>
                            <input id='new-project-title' type='text' placeholder='Enter Project Title'/>
                        </div>
                        <input id='btn-create-project' type='button' value='Confirm'/>
                    </div>
                </div>
            </div>
            <div id='page-room-1' class='page-room'>
                <div class='pageContentOuter'>
                  <div class='pageContent'>
                      <h2 class='room-title-heading' data-room-number="1">
                          <input name='room-title' type='text' placeholder='Enter Room Name' class='room-title' value='Room 1' />
                      </h2>
                      <div class='results'>RESULTS</div>
                      <form class='room-form'> 
                          <div class='group-label'>
                              <span>Room</span>
                          </div>
                          <div class='form-group'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>L</label>
                                      <input name='room-length' class='room-length form-control decimal' type='number' step='any' min='0' placeholder='enter length' >
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='room-width' class='room-width form-control decimal' type='number' step='any' min='0' placeholder='enter width'>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='room-height' class='room-height form-control decimal' type='number' step='any' min='0' placeholder='enter height' >
                                  </div>
                              </div>
                          </div>

                          <div class='group-label'>
                              <span>Door</span>
                          </div>
                          <div class='form-group'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>#</label>
                                      <input name='door-qty' class='door-qty form-control integer' type='number' step='1' min='0' placeholder='enter quantity'>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='door-width' class='door-width form-control decimal' type='number' step='any' min='0' placeholder='enter width'>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='door-height' class='door-height form-control decimal' type='number' step='any' min='0' placeholder='enter width'>
                                  </div>
                              </div>
                          </div>

                          <div class='group-label'>
                              <span>Window</span>
                          </div>
                          <div class='form-group'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>#</label>
                                      <input name='window-qty' class='window-qty form-control integer' type='number' step='1' min='0' placeholder='enter quantity'/>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='window-width' class='window-width form-control decimal' type='number' step='any' min='0' placeholder='enter width' />
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='window-height' class='window-height form-control decimal' type='number' step='any' min='0' placeholder='enter height' />
                                  </div>
                              </div>
                          </div>

                          <div class='group-label'>
                              <span>Radiator</span>
                          </div>
                          <div class='form-row'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>#</label>
                                      <input name='radiator-qty' class='radiator-qty form-control integer' type='number' step='any' min='0' placeholder='enter quantity'/>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='radiator-width' class='radiator-width form-control decimal' type='number' step='any' min='0' placeholder='enter width' />
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='radiator-height' class='radiator-height form-control decimal' type='number' step='any' min='0' placeholder='enter height'/>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group baybreast-group'>
                              <div class='group-label'>
                                  <span>Bay or Breast</span>
                              </div>
                              <div class='input-block'>
                                  <div class='input-row'>
                                      <span class='positive-negative-first'>±</span>
                                      <input name='baybreast-width' class='baybreast-width decimal' type='number' step='any' placeholder='width'/>
                                      <input name='baybreast-depth' class='baybreast-depth decimal' type='number' step='any' min='0' placeholder='depth'/>
                                      <button type='button' class='btn-add-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='blue' />
                                              <polygon points='12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12' fill='white' />
                                          </svg>
                                      </button>
                                      <button type='button' class='btn-remove-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='red' />
                                              <polygon points='6,12 24,12 24,18 6,18 6,12' fill='white' />
                                          </svg>
                                      </button>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group ceiling-adjust-group'>
                              <div class='group-label'>
                                  <span>Ceiling Adjusts</span>
                              </div>
                              <div class='form-row'>
                                  <span class='positive-negative-first'>±</span>
                                  <input name='ceiling-adjust-simple' class='ceiling-adjust-simple decimal' type='number' step='any' placeholder='amount'/>
                              </div>
                              <div class='input-block'>
                                  <div class='input-row'>
                                      <span class='positive-negative-first'>±</span>
                                      <input name='ceiling-adjust-dim1' class='ceiling-adjust-dim1 decimal' type='number' step='any' placeholder='amount'/>
                                      <input name='ceiling-adjust-dim2' class='ceiling-adjust-dim2 decimal' type='number' min='0' step='any' placeholder='amount'/>
                                      <button type='button' class='btn-add-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='blue' />
                                              <polygon points='12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12' fill='white' />
                                          </svg>
                                      </button>
                                      <button type='button' class='btn-remove-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='red' />
                                              <polygon points='6,12 24,12 24,18 6,18 6,12' fill='white' />
                                          </svg>
                                      </button>
                                  </div>
                              </div>
                          </div>
                          
                          <div class='input-group wall-adjust-group'>
                              <div class='group-label'>
                                  <span>Wall Adjusts</span>
                              </div>
                              <div class='form-row'>
                                  <span class='positive-negative-first'>±</span>
                                  <input name='wall-adjust-simple' type='number' step='any' placeholder='amount' class='wall-adjust-simple decimal'/>
                              </div>
                              <div class='input-block'>
                                  <div class='input-row'>
                                      <span class='positive-negative-first'>±</span>
                                      <input name='wall-adjust-dim1' type='number' step='any' placeholder='amount' class='wall-adjust-dim1 decimal'/>
                                      <input name='wall-adjust-dim2' type='number' min='0' step='any' placeholder='amount' class='wall-adjust-dim2 decimal'/>
                                      <button type='button' class='btn-add-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='blue' />
                                              <polygon points='12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12' fill='white' />
                                          </svg>
                                      </button>
                                      <button type='button' class='btn-remove-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='red' />
                                              <polygon points='6,12 24,12 24,18 6,18 6,12' fill='white' />
                                          </svg>
                                      </button>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group general-surface-group'>
                              <div class='group-label'>
                                  <span>General Surface</span>
                              </div>
                              <div class='input-block'>
                                  <div class="dropdown">
                                      <button class="dropdown-btn dropdown-toggle" type="button" data-toggle="dropdown">
                                          <span class='dropdown-text'>Dropdown</span>
                                          <input type='hidden' class='dropdown-value general-surface-prod-rate'/>
                                          <span class="caret"></span>
                                      </button>
                                      <ul class="dropdown-menu" role="menu">
                                          <li role='presentation'><a role='menuitem' tabindex="-1" href="#" data-value='4'>General surface (4)</a></li>
                                          <li role='presentation'><a role='menuitem' tabindex="-1" href="#" data-value='3.5'>Glazed med pane (3.5)</a></li>
                                          <li role='presentation'><a role='menuitem' tabindex="-1" href="#" data-value='2.5'>Glazed small pane (2.5)</a></li>
                                      </ul>
                                      <button type='button' class='btn-add-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='blue' />
                                              <polygon points='12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12' fill='white' />
                                          </svg>
                                      </button>
                                      <button type='button' class='btn-remove-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='red' />
                                              <polygon points='6,12 24,12 24,18 6,18 6,12' fill='white' />
                                          </svg>
                                      </button>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>#</label>
                                          <input class='form-control general-surface-qty integer' name='general-surface-qty' type='number' step='1' min='0' placeholder='enter quantity'/>
                                      </div>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>W</label>
                                          <input class='form-control general-surface-width decimal' name='general-surface-width' type='number' step='any' min='0' placeholder='enter width'/>
                                      </div>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>H</label>
                                          <input class='form-control general-surface-height decimal' name='general-surface-height' type='number' step='any' min='0' placeholder='enter height'/>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group isolated-surface-group'>
                              <div class='group-label'>
                                  <span>Isolated Surface</span>
                              </div>
                              <div class='input-block'>
                                  <div class="dropdown">
                                      <button class="dropdown-btn dropdown-toggle" type="button" data-toggle="dropdown">
                                          <span class='dropdown-text'>Dropdown</span>
                                          <input type='hidden' class='dropdown-value isolated-surface-prod-rate'/>
                                          <span class="caret"></span>
                                      </button>
                                      <ul class="dropdown-menu" role="menu">
                                          <li role='presentation'><a role='menuitem' tabindex="-1" href="#" data-value='15'>100 Girth (15)</a></li>
                                          <li role='presentation'><a role='menuitem' tabindex="-1" href="#" data-value='3.5'>Glazed med pane (3.5)</a></li>
                                          <li role='presentation'><a role='menuitem' tabindex="-1" href="#" data-value='10'>G300 Girth (10)</a></li>
                                      </ul>
                                      <button type='button' class='btn-add-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='blue' />
                                              <polygon points='12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12' fill='white' />
                                          </svg>
                                      </button>
                                      <button type='button' class='btn-remove-row'>
                                          <svg height='30' width='30'>
                                              <circle cx='15' cy='15' r='15' fill='red' />
                                              <polygon points='6,12 24,12 24,18 6,18 6,12' fill='white' />
                                          </svg>
                                      </button>
                                  </div>
                                  <div class='input-pill'>
                                      <div class='input-pill'>
                                          <div class="input-pill-inner">
                                              <label class='control-label'>#</label>
                                              <input class='form-control isolated-surface-qty integer' name='isolated-surface-qty' type='number' step='1' min='0' placeholder='enter quantity'/>
                                          </div>
                                      </div>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>L</label>
                                          <input class='form-control isolated-surface-length decimal' name='isolated-surface-length' type='number' step='any' min='0' placeholder='enter length'/>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <input type='button' id='btn-calculate' class='btn-room-calculate' value='Calculate'/>

                      </form>
                    </div>
                </div>
            </div>
        </div>
<script type='text/javascript'>
    //Global variable to store current project data
    var CURRENT_PROJECT = {};
    var PAINTS = JSON.parse('{{ paints|safe }}');
    var SURFACE_TYPES = ['Ceilings','Walls','Doors','Door Frames','Windows','Radiators','Skirtings'];

    //Add the projects to the select list
    function populateProjects(projects){
        $('#select-project').find('option').remove();
        for(var i=0; i<projects.length; i++){
            $('#select-project')
              .append(
                  $('<option></option>')
                    .attr('value',projects[i].id)
                    .text(projects[i].title + ' (' 
                      + projects[i].date_created.split('.')[0]
                        .replace('T',' ') + ')'
                    )
              ); 
        }
    }

    function populateRoomDefaults(){
        var $elem;
        {% for key, value in default_room.to_dict().iteritems() if (key != 'is_default' and key != 'key') %}
        $elem = $('#default-{{key.replace("_","-")}}' );
        $elem.val( {{ value }} );
        {% endfor %}
    }

    function selectProject(){
        $.ajax({
            type: 'POST',
            url: '/getproject',
            data: { project_key: $('#select-project').val() },
            success: function(data){ 
                CURRENT_PROJECT = JSON.parse(data);
                $('#app-title').text('Paint Survey - ' + CURRENT_PROJECT.title);
                //TODO: fetch and populate the room data according to whichever project is selected
            }
        });
    }

    function createProject(){
        if($('#new-project-title').val().match(/\S/g)){
            $.ajax({
                type: 'POST',
                url: '/createproject',
                data: { projectTitle: $('#new-project-title').val() },
                success: function(data){ 
                  alert('Project created successfully.'); 
                  populateProjects(JSON.parse(data));
                  //selectProject();
                }
            });
        }else{
            alert('Project title can not be blank!');
        }
    }

    function populateRoomWithDefaults(){
        var getf = function(elemId){
            return parseFloat($(elemId).val()).toFixed(2);
        }
        $('.room-height').val(getf('#default-room-height'));
        $('.door-width').val(getf('#default-door-width'));
        $('.door-height').val(getf('#default-door-height'));
        $('.window-width').val(getf('#default-window-width'));
        $('.window-height').val(getf('#default-window-height'));
        $('.radiator-width').val(getf('#default-radiator-width'));
        $('.radiator-height').val(getf('#default-radiator-height'));
    }

    function calculateWorkForRoom(event){

        //Validate input first.
        if(!$(event.target).closest('.room-form').validate({ 
                errorPlacement: function(error, element) {
                    error.insertAfter(element.closest('.input-pill'));
                }
            }).form()){
            return;
        }

        var getf = function(descendant, ancestor){
            var $elem = $(event.target).closest('.pageContent'); 
            $elem = (typeof ancestor  != 'undefined') ? $(ancestor) : $elem;
            var floatVal = parseFloat($elem.find(descendant).val());
            return Math.abs(floatVal)>=0 ? floatVal : 0; 
        }
        
        var roomLength =          getf('.room-length:first');
        var roomWidth =           getf('.room-width:first');
        var roomHeight =          getf('.room-height:first');
        var doorQty =             getf('.door-qty:first');
        var doorWidth =           getf('.door-width:first');
        var doorHeight =          getf('.door-height:first');
        var windowQty =           getf('.window-qty:first');
        var windowWidth =         getf('.window-width:first');
        var windowHeight =        getf('.window-height:first');
        var radiatorQty =         getf('.radiator-qty:first');
        var radiatorWidth =       getf('.radiator-width:first');
        var radiatorHeight =      getf('.radiator-height:first');
        var ceilingAdjust =       getf('.ceiling-adjust-simple');
        var wallAdjust =          getf('.wall-adjust-simple');

        var baybreastWall = 0;
        var baybreastCeiling = 0;
        var baybreastSkirting = 0;

        var genSurfSpace = 0;
        var genSurfHours = 0;

        var isolSurfSpace = 0;
        var isolSurfHours = 0;

        $('.baybreast-group .input-block').each( function(index, elem){
            var bbDepth = getf('.baybreast-depth', elem);
            var bbWidth = getf('.baybreast-width', elem);
            if(Math.abs(bbDepth * bbWidth) > 0){
                baybreastWall += (2 * bbDepth * roomHeight);
                baybreastCeiling += (bbWidth * bbDepth);
                baybreastSkirting += (2 * bbDepth);
            }
        });

        $('.ceiling-adjust-group .input-block').each( function(index, elem){
            var dim1 = getf('.ceiling-adjust-dim1', elem);
            var dim2 = getf('.ceiling-adjust-dim2', elem);
            if(Math.abs(dim1 * dim2) > 0) ceilingAdjust += (dim1 * dim2);
        });

        $('.wall-adjust-group .input-block').each( function(index, elem){
            var dim1 = getf('.wall-adjust-dim1', elem);
            var dim2 = getf('.wall-adjust-dim2', elem);
            if(Math.abs(dim1 * dim2) > 0) wallAdjust += (dim1 * dim2);
        });

        $('.general-surface-group .input-block').each( function(index, elem){
            var prodRate = getf('.general-surface-prod-rate', elem);
            var quantity = getf('.general-surface-qty', elem);
            var dim1 = getf('.general-surface-width', elem);
            var dim2 = getf('.general-surface-height', elem);
            if(Math.abs(quantity * dim1 * dim2) > 0) {
                genSurfSpace += (quantity * dim1 * dim2);
                genSurfHours += ((quantity * dim1 * dim2) / prodRate);
            }
        });

        $('.isolated-surface-group .input-block').each( function(index, elem){
            var prodRate = getf('.isolated-surface-prod-rate', elem);
            var quantity = getf('.isolated-surface-qty', elem);
            var dim1 = getf('.isolated-surface-length', elem);
            if(Math.abs(quantity * dim1) > 0) {
                isolSurfSpace += (quantity * dim1);
                isolSurfHours += ((quantity * dim1) / prodRate);
            }
        });

        var doorSpace =     doorQty * doorWidth * doorHeight;
        var doorFrame =     (doorHeight * 2 + doorWidth) * doorQty;
        var windowSpace =   windowQty * windowWidth * windowHeight;
        var ceilingSpace =  (roomLength * roomWidth) + baybreastCeiling + ceilingAdjust; 
        var wallSpace =     (roomLength + roomWidth) * 2 * roomHeight - doorSpace - windowSpace + baybreastWall + wallAdjust; 
        var skirtingSpace = (roomLength + roomWidth) * 2 - (doorWidth * doorQty) + baybreastSkirting;
        var radiatorSpace = radiatorQty * radiatorWidth * radiatorHeight;

        var tableData = [
            { title: 'CEILING',     amount: ceilingSpace,    units: 'm2', hours: ceilingSpace / parseInt($('#select-ceilings-prod-rate').val()) },
            { title: 'WALL',        amount: wallSpace,       units: 'm2', hours: wallSpace / parseInt($('#select-walls-prod-rate').val()) },
            { title: 'DOOR AREA',   amount: doorSpace,       units: 'm2', hours: doorSpace / parseInt($('#select-doors-prod-rate').val()) },
            { title: 'DOOR FRAME',  amount: doorFrame,       units: 'm',  hours: doorFrame / parseInt($('#select-door-frames-prod-rate').val()) },
            { title: 'WINDOW',      amount: windowSpace,     units: 'm2', hours: windowSpace / parseInt($('#select-windows-prod-rate').val()) },
            { title: 'RADIATOR',    amount: radiatorSpace,   units: 'm2', hours: radiatorSpace / parseInt($('#select-radiators-prod-rate').val()) },
            { title: 'SKIRTING',    amount: skirtingSpace,   units: 'm2', hours: skirtingSpace / parseInt($('#select-skirtings-prod-rate').val()) }, 
            { title: 'GENERAL SURFACE',    amount: genSurfSpace,   units: 'm2', hours: genSurfHours },
            { title: 'ISOLATED SURFACE',    amount: isolSurfSpace,   units: 'm', hours: isolSurfHours }
        ];

        $(event.target).closest('.pageContent').find('.results:first').html(buildResultsTable(tableData));

        window.scrollTo(0,0);
    }

    function buildResultsTable(tableData){
        var results = '<table><tr><th>Part</th><th>Amount</th><th></th><th>Hours</th></tr>';
        var totalHours = 0;
        
        for (i = 0; i < tableData.length; ++i) {
            obj = tableData[i];
            results += '<tr>';
            for (var key in obj){
                if (obj.hasOwnProperty(key)) {
                    var val = 0;
                    var cssClass = 'class="tdRightAlign"';
                    if(key == 'amount' ){
                        val = roundAndFix(obj[key], 2);
                    }else if(key == 'hours'){
                        val = roundAndFix(obj[key], 2);
                        totalHours += parseFloat(val);
                    }else{
                        val = obj[key];
                        cssClass = '';
                    }
                    results += '<td ' + cssClass + '>' + val + '</td>';
                }
            }
            results += '</tr>';
        }

        results += '<tr class="rowTotalHours"><td>TOTAL:</td><td></td><td></td><td class="tdRightAlign">' + totalHours.toFixed(2) + '</td></tr>';
        results += '</table>';
        return results;
    }

    function roundAndFix (number, precision) {
        var multiplier = Math.pow (10, precision);
        var result = Math.round (number * multiplier) / multiplier;
        return result.toFixed(precision);
    }

    function keydownDecimalInput(event){

        var $elem = $(this);

        // Allow: backspace, delete, tab, escape, enter, ctrl+A
        if ($.inArray(event.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
             // Allow: Ctrl+A
            (event.keyCode == 65 && event.ctrlKey === true) || 
             // Allow: home, end, left, right
            (event.keyCode >= 35 && event.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }

        //If the input allows negative numbers allow '-' minus sign.
        if(event.keyCode == 189){
            if(!$elem.attr('min') || parseFloat($elem.attr('min')) < 0){
                //if already minus sign or number before, prevent.
                if(/[0-9\-]/.test($elem.val())) {
                    event.preventDefault();
                }
                return
            }
        }

        //If not number or decimal point, prevent.
        if(/[^0-9]/.test(String.fromCharCode(event.keyCode))
          && event.keyCode != 190 ){
            event.preventDefault();
            return;
        };

        //if already decimal point, prevent.
        if(event.keyCode == 190 && /\./.test(this.value)) {
            event.preventDefault();
            return;
        }
    }

    function keyupDecimalInput(event){
        var $elem = $(this);
        if($elem.val().length > 0){
            if($elem.val() > 0){
                $elem.css('color','black');
            }else{
                $elem.css('color','red');
            }
        }
        
    }

    function keydownIntegerInput(event){
        // Allow: backspace, delete, tab, escape, enter, ctrl+A
        if ($.inArray(event.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
             // Allow: Ctrl+A
            (event.keyCode == 65 && event.ctrlKey === true) || 
             // Allow: home, end, left, right
            (event.keyCode >= 35 && event.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }

        //If not number, prevent
        if(/[0-9]/.test(String.fromCharCode(event.keyCode))) return;

        event.preventDefault();  
    }

    function blurDecimal(){
        //Enforce 2 decimal places.
        if(this.value.trim() == '.') this.value = '0.00';
        if(this.value.length >= 1 && Math.abs(parseFloat(this.value)) > 0){
            this.value = parseFloat(this.value).toFixed(2);
        }else{
            this.value = '';
        }
        //Set red color for negative values
        var $elem = $(this);
        if($elem.val().length > 0){
            if($elem.val() > 0){
                $elem.css('color','black');
            }else{
                $elem.css('color','red');
            }
        }
    }

    function blurInputFocus(event){
        var tagName = event.target.tagName.toLowerCase();
        var role = event.target.getAttribute('role');
        if(tagName != 'input' && tagName != 'select'){
            $(':focus').blur();
        }
        if(tagName != 'button' && role != 'menuitem'){
           $('.dropdown.open').removeClass('open');
        }
    }

    function roomDefaultsChange(){
        //Update the corresponding input on the room 1 screen.
        var $elem = $(this);
        //alert('*' + $elem.attr('id'));
        $('.' + $elem.attr('id').replace('default-','')).val($elem.val());
    }

    function switchSign(event){
        $btn = $(this);
        $input = $btn.next('input[type="number"]');
        $input.val(-1 * $input.val());
        $input.blur();
    }

    function initOwlCarousel(){
        $('#owl-carousel').owlCarousel(
            { 
                navigation : true, // Show next and prev buttons
                slideSpeed : 300,
                paginationSpeed : 400,
                singleItem: true,
                afterInit : function(elem){
                  var that = this;
                  that.owlControls.prependTo(elem);
                  this.jumpTo(2);
                }
            }
        );
    }

    function toggleDropDown(){
        var $dropdown = $(this).closest('.dropdown');
        var c = 'open';
        if($dropdown.hasClass(c)){
            $dropdown.removeClass(c);
        }else{
            $dropdown.addClass(c);
        };
    }

    function selectDropDownItem(){
        //find the closest drop down and set the value of the hidden input.
        var $clickedItem = $(this);
        var $dropdown = $clickedItem.closest('.dropdown');
        $dropdown.find('.dropdown-value').val( $clickedItem.data('value') );
        $dropdown.find('.dropdown-text').text( $clickedItem.text() );
        $dropdown.removeClass('open');
        return false;
    }

    function initDropdowns(){
        $('.dropdown').each( function(index, elem){
            var $elem = $(elem);
            var selectedValue = $elem.find('.dropdown-value').val();
            if (typeof selectedValue === 'undefined' || selectedValue == ''){
                var defaultItem = $elem.find('.dropdown-menu a:first');
                $elem.find('.dropdown-value').val( defaultItem.data('value') );
                $elem.find('.dropdown-text').text( defaultItem.text() );
                $elem.find('.dropdown-btn').click( toggleDropDown );
                $elem.find('.dropdown-menu a').bind( 'click touchstart', selectDropDownItem );
            }
        });
    }

    function showEditSpecView(){
        var $clickedButton = $(this);
        
        var surface_type = $clickedButton.closest('.spec-item-block')
                              .find('.spec-item-title').text();
        //For each paint of this surface type, build the edit inputs.
        $.each(PAINTS, function(i, paint) {  
            if (paint.surface_type.toLowerCase() == surface_type.toLowerCase()) {
                var $newBlock = $('#form-edit-spec .input-block:first').clone();
                $newBlock.find('input.spec-paint-key').val(paint.key);
                $newBlock.find('input.spec-item-name').val(paint.name);
                $newBlock.find('input.spec-item-rate').val(paint.prod_rate);
                $newBlock.removeClass('hidden');
                $newBlock.insertAfter('#form-edit-spec .input-block:last');
                $btnRemove = $newBlock.find('.btn-remove-row:first');
                $btnRemove.css('display','block');
                $btnRemove.click(function(event){ $(event.target).closest('.input-block').remove(); });
            }
        });
        
        initDecimalInputs();

        $('#form-view-spec').fadeOut('fast', function(){
            $('#form-edit-spec').fadeIn('fast');
        });
    }

    function initSpecificationPage(){
        //For each surface type, build the dropdown menus.
        for(var i = 0; i < SURFACE_TYPES.length; i++){
            $newBlock = $('.spec-item-block:first').clone();
            $newBlock.find('.spec-item-title').text( SURFACE_TYPES[i] );
            $.each(PAINTS, function(j, obj) {
                if (obj.surface_type == SURFACE_TYPES[i]) {
                    $newBlock.find('.dropdown-value').attr('id',
                        'select-' + obj.surface_type.toLowerCase().replace(' ', '-') + '-prod-rate');
                    $newBlock.find('ul.dropdown-menu').append(
                        '<li><a role="menuitem" data-value="' + obj.prod_rate + '" >' 
                        + obj.name + ' (' + obj.prod_rate + ') </a></li>'
                    );
                }
            });
            $newBlock.removeClass('hidden');
            $newBlock.appendTo('#form-view-spec');
        }
        //Setup button click events for edit view
        $('#form-edit-spec .btn-save').click( function(){ 
            //TODO: make ajax save POST to server.
            $('#form-edit-spec').fadeOut('fast', function(){
                $('#form-edit-spec .input-block:not(.hidden)').remove();
                $('#form-view-spec').fadeIn('fast');
            });
        });
        $('#form-edit-spec .btn-cancel').click( function(){ 
            $('#form-edit-spec').fadeOut('fast', function(){
                $('#form-edit-spec .input-block:not(.hidden)').remove();
                $('#form-view-spec').fadeIn('fast');
            });
        });
    }

    function initDecimalInputs(){
        $('.decimal').keydown( keydownDecimalInput );
        $('.decimal').keyup( keyupDecimalInput );
        $('.decimal').bind( 'blur', blurDecimal );
        $('.decimal').blur();
    }

    function initAddInputBlockButtons(){
        $('#btn-add-spec-item,.btn-add-row').click( function(){
            var $group = $(event.target).closest('.input-group');
            var $newBlock = $group.find('.input-block:last').clone();
            $newBlock.find('.btn-add-row:first').remove();
            $newBlock.find('input').val('');
            $newBlock.find('input').keydown( keydownDecimalInput );
            $newBlock.find('input').blur( blurDecimal );
            $newBlock.find('dropdown').removeClass('open');
            $newBlock.find('.positive-negative-first,.positive-negative-second').click( switchSign );
            $newBlock.removeClass('hidden');
            $newBlock.insertAfter($group.find('.input-block:last'));
            initDropdowns();
            $btnRemove = $newBlock.find('.btn-remove-row:first');
            $btnRemove.css('display','block');
            $btnRemove.click(function(event){ $(event.target).closest('.input-block').remove(); });
        });
    }

    $(document).ready(function() {
        initOwlCarousel();
        initSpecificationPage();
        $('.integer').keydown( keydownIntegerInput );
        initDecimalInputs();
        $('#form-room-defaults input[type="number"]').change( roomDefaultsChange );
        $('#btn-select-project').click( selectProject );
        $('#btn-create-project').click( createProject );
        $('.positive-negative-first,.positive-negative-second').click( switchSign );
        initAddInputBlockButtons();
        $('.btn-room-calculate').click( calculateWorkForRoom );
        initDropdowns();
        $('body').bind('touchstart click', blurInputFocus );
        populateRoomDefaults();
        populateRoomWithDefaults();
        $('.btn-edit-spec').click( showEditSpecView );
    });
</script>
    </body>
</html>