<!doctype html>
<html>
    <head>
        <title>Paint Survey</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" type="text/css" href="static/main.css" />
        <link rel="stylesheet" type="text/css" href="static/owl-carousel/owl.carousel.css" />
        <link rel="stylesheet" href="static/owl-carousel/owl.theme.css" />
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="static/owl-carousel/owl.carousel.js"></script>
    </head>
    <body>
        <h1 id='app-title'>Paint Survey</h1>
        <div id='owl-example' class='owl-carousel'>
            <div id='page-left-3'>
                <h2>Production Rates Defaults</h2>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <form id='form-production-rates'>
                          <div class='form-row'>
                            <label>Ceilings</label>
                            <select>
                              <option value="test">1 Vinyl Matt</option>
                              <option value="test">2 Vinyl Matt</option>
                              <option value="test">2 Eggshell</option>
                            </select>
                          </div>
                          <div class='form-row'>
                            <label>Walls</label>
                            <select>
                              <option value="test">Wallpaper</option>
                              <option value="test">2 Vinyl Matt</option>
                              <option value="test">2 Eggshell</option>
                            </select>
                          </div>
                          <div class='form-row'>
                            <label>Doors</label>
                            <select>
                              <option value="test">General surface</option>
                              <option value="test">Glazed med pane</option>
                              <option value="test">Glazed small pane</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Architraves</label>
                            <select>
                              <option value="test">150 Girth</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Windows</label>
                            <select>
                              <option value="test">Large pane</option>
                              <option value="test">Med pane</option>
                              <option value="test">Small pane</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Radiators</label>
                            <select>
                              <option value="test">Panel</option>
                              <option value="test">Column</option>
                            </select>
                          </div>
                          <div class='form-row'>  
                            <label>Skirtings</label>
                            <select>
                              <option value="test">150 Girth</option>
                            </select>
                          </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id='page-left-2'>
                <h2>Room Settings Defaults</h2>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                      <form id='form-production-rates'>
                        <div class='form-row'>
                          <label>Room length</label>
                          <input id='default-room-length' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>
                          <label>Room width</label>
                          <input id='default-room-width' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>
                          <label>Room height</label>
                          <input id='default-room-height' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Door quantity</label>
                          <input id='default-door-quantity' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Door width</label>
                          <input id='default-door-width' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Door height</label>
                          <input id='default-door-height' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Window quantity</label>
                          <input id='default-window-quantity' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Window width</label>
                          <input id='default-window-width' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Window height</label>
                          <input id='default-window-height' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Radiator quantity</label>
                          <input id='default-radiator-quantity' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Radiator width</label>
                          <input id='default-radiator-width' type='text' class='numbersOnly'/>
                        </div>
                        <div class='form-row'>  
                          <label>Radiator height</label>
                          <input id='default-radiator-height' type='text' class='numbersOnly'/>
                        </div>
                      </form>
                    </div>
                </div>
            </div>
            <div id='page-left-1'>
                <h2>Projects</h2>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <div class='form-row'>  
                            <label>Select Existing</label>
                            <select id='select-project'>
                                {% for p in projects %}
                                <option value='{{ p.key.urlsafe() }}'>{{ p.title }} {{ p.date_created }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input id='btn-select-project' type='button' value='Confirm'/>
                        <div class='form-row'>
                            <label>Create New</label>
                            <input id='new-project-title' type='text' placeholder='Enter Project Title'/>
                        </div>
                        <input id='btn-create-project' type='button' value='Confirm'/>
                    </div>
                </div>
            </div>
            <div id='page-home'>
                <h2 class="room-title" data-room-number="1">Room 1</h2>
                {{ include_file('page-room.html') }}
            </div>
            <div id='page-right-1'>
                <h2 class="room-title" data-room-number="2">Room 2</h2>
                {{ include_file('page-room.html') }}
            </div>
            <div id='page-right-2'>
                <h2 class="room-title" data-room-number="3">Room 3</h2>
                {{ include_file('page-room.html') }}
            </div>
        </div>
        <script>
            //Global variable to store current project data
            var CURRENT_PROJECT = {};

            //Add the projects to the select list
            function populateProjects(projects){
                $('#select-project').find('option').remove();
                for(var i=0; i<projects.length; i++){
                    $('#select-project')
                      .append(
                          $('<option></option>')
                            .attr('value',projects[i].id)
                            .text(projects[i].title + ' (' 
                              + projects[i].date_created.split('.')[0]
                                .replace('T',' ') + ')'
                            )
                      ); 
                }
            }

            function populateRoomDefaults(){
                {% for key, value in default_room.to_dict().iteritems() if key != 'is_default'%}
                $('#default-{{key.replace("_","-")}}' ).val( {{ value }} );
                {% endfor %}
            }

            function selectProject(){
                $.ajax({
                    type: 'POST',
                    url: '/getproject',
                    data: { project_key: $('#select-project').val() },
                    success: function(data){ 
                        CURRENT_PROJECT = JSON.parse(data);
                        $('#app-title').text('Paint Survey - ' + CURRENT_PROJECT.title);
                        alert('Project selected: ' + CURRENT_PROJECT.title ); 
                        //TODO: fetch and populate the room data according to whichever project is selected
                    }
                });
            }

            function createProject(){
                if($('#new-project-title').val().match(/\S/g)){
                    $.ajax({
                        type: 'POST',
                        url: '/createproject',
                        data: { projectTitle: $('#new-project-title').val() },
                        success: function(data){ 
                          alert('Project created successfully.'); 
                          populateProjects(JSON.parse(data));

                          //selectProject();
                        }
                    });
                }else{
                    alert('Project title can not be blank!');
                }
            }

            function calculateWorkForRoom(){
                var page = $(event.target).closest('.pageContent');
                
                var rmLength =      parseFloat(page.find('#roomLength:first').val());
                var rmWidth =       parseFloat(page.find('#roomWidth:first').val());
                var rmHeight =      parseFloat(page.find('#roomHeight:first').val());
                var doorQty =       parseFloat(page.find('#doorQty:first').val());
                var doorWidth =     parseFloat(page.find('#doorWidth:first').val());
                var doorHeight =    parseFloat(page.find('#doorHeight:first').val());
                var windowQty =     parseFloat(page.find('#windowQty:first').val());
                var windowWidth =   parseFloat(page.find('#windowWidth:first').val());
                var windowHeight =  parseFloat(page.find('#windowHeight:first').val());
                var radiatorQty =     parseFloat(page.find('#radiatorQty:first').val());
                var radiatorWidth =   parseFloat(page.find('#radiatorWidth:first').val());
                var radiatorHeight =  parseFloat(page.find('#radiatorHeight:first').val());
          
                var doorSpace =     doorQty * doorWidth * doorHeight;
                var doorFrame =     (doorHeight * 2 + doorWidth) * doorQty;
                var windowSpace =   windowQty * windowWidth * windowHeight;
                var ceilingSpace =  (rmLength * rmWidth); 
                var wallSpace =     (rmLength + rmWidth) * 2 * rmHeight - doorSpace - windowSpace; 
                var skirtingSpace = (rmLength + rmWidth) * 2 - doorWidth * doorQty;
                var radiatorSpace = radiatorQty * radiatorWidth * radiatorHeight;
          
                var results = '<table><tr><th>Part</th><th>Result</th></tr>';
                results += ('<tr><td>CEILING:</td><td class="result">'    + ceilingSpace.toFixed(2)  + ' m2</td></tr>');
                results += ('<tr><td>WALL:</td><td class="result">'       + wallSpace.toFixed(2)     + ' m2</td></tr>');
                results += ('<tr><td>DOOR:</td><td class="result">'       + doorSpace.toFixed(2)     + ' m2</td></tr>');
                results += ('<tr><td>DOORFRAME:</td><td class="result">'  + doorFrame.toFixed(2)     + '</td></tr>');
                results += ('<tr><td>WINDOW:</td><td class="result">'     + wallSpace.toFixed(2)     + ' m2</td></tr>');
                results += ('<tr><td>RADIATOR:</td><td class="result">'   + radiatorSpace.toFixed(2) + ' m2</td></tr>');
                results += ('<tr><td>SKIRTING:</td><td class="result">'   + skirtingSpace.toFixed(2) + '</td></tr>');
                results += '</table>';
                
                page.find('.results:first').html(results);
                window.scrollTo(0,0);
            }

            function initOwlCarousel(){
                $("#owl-example").owlCarousel(
                    { 
                        navigation : true, // Show next and prev buttons
                        slideSpeed : 300,
                        paginationSpeed : 400,
                        singleItem:true,
                        afterInit : function(elem){
                          var that = this;
                          that.owlControls.prependTo(elem);
                          this.jumpTo(2);
                        }
                    }
                );
            }

            $(document).ready(function() {
              
                initOwlCarousel();
                populateRoomDefaults();

                $('.numbersOnly').keyup(function () {
                    var result = this.value.replace(/[^0-9\.]/g, '');
                    if (this.value != result) {
                        this.value = result;
                    }
                }); 

                $('#btn-select-project').click( selectProject );
                $('#btn-create-project').click( createProject );
                $('.btn-room-calculate').click( calculateWorkForRoom );
            });
        </script>
    </body>
</html>