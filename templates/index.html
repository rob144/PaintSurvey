<!doctype html>
<html>
    <head>
        <title>Paint Survey</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" type="text/css" href="/static/main.css" />
        <link rel="stylesheet" type="text/css" href="/static/owl-carousel/owl.carousel.css" />
        <link rel="stylesheet" href="/static/owl-carousel/owl.theme.css" />
        <script src="/static/lib/jquery-1.11.2.min.js"></script>
        <script src="/static/lib/jquery.validate.min.js"></script>
        <script src="/static/owl-carousel/owl.carousel.js"></script>
    </head>
    <body>
        <h1 id='app-title'>Paint Survey</h1>
        <div id='owl-carousel' class='owl-carousel'></div>

        <div id='owl-pages'>
            <div id='page-specification' class='owl-page'>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                            
                        <form id='form-edit-spec'>
                            <div class='input-group'>
                                <h2 class='group'>Edit Specification
                                <button type='button' id='btn-add-spec-item'></button>
                                </h2>
                                <input type='text' id='spec-surface-type' value='surface type' disabled="disabled" />
                                <div id='spec-list'>
                                    <div class='input-block hidden'>
                                        <input type='hidden' class='spec-item-key'/>
                                        <input type='hidden' class='spec-item-order'/>
                                        <div class='form-row group'>
                                            <label>Item Name</label>
                                            <input class='spec-item-name' type='text' placeholder='item name'/>
                                            <button type='button' class='btn-remove-row'></button>
                                        </div>
                                        <div class='form-row group'>
                                            <label>Production Rate</label>
                                            <input class='spec-item-rate decimal' type='number' step='any' min='0' placeholder='rate'/>
                                            <button type='button' class='btn-reorder-item-up'></button>
                                            <button type='button' class='btn-reorder-item-down'></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type='button' class='btn-save'>Save</button>
                            <button type='button' class='btn-cancel'>Cancel</button>
                        </form>

                        <form id='form-view-spec'>
                            <h2>Specification</h2>
                                <div class='form-row spec-item-block hidden'>
                                    <label class='spec-item-title'>Surface Type Title</label>
                                    <div class="dropdown">
                                        <button class="dropdown-btn dropdown-toggle" type="button" data-toggle="dropdown">
                                            <span class='dropdown-text'>Dropdown</span>
                                            <input type='hidden' id='select-paint-prod-rate' class='dropdown-value'/>
                                            <span class="caret"></span>
                                        </button>
                                        <ul class='dropdown-menu' role='menu'></ul>
                                        <button type='button' class='btn-edit-spec'></button>
                                    </div>
                                </div>
                            </ul>
                        </form>

                    </div>
                </div>
            </div>
            <div id='page-room-defaults' class='owl-page'>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <h2>Default Room Settings</h2>
                        <form id='form-room-defaults'>
                            <input id='default-room-key' type='hidden'/>
                            <div class='form-row'>
                                <label>Room height</label>
                                <input id='default-room-height' type='number' step='any' min='0' placeholder='height' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Door width</label>
                                <input id='default-door-width' type='number' step='any' min='0' placeholder='width' class='decimal round-corners-input' />
                            </div>
                            <div class='form-row'>  
                                <label>Door height</label>
                                <input id='default-door-height' type='number' step='any' min='0' placeholder='height' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Window width</label>
                                <input id='default-window-width' type='number' step='any' min='0' placeholder='width' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Window height</label>
                                <input id='default-window-height' type='number' step='any' min='0' placeholder='height' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Radiator width</label>
                                <input id='default-radiator-width' type='number' step='any' min='0' placeholder='width' class='decimal round-corners-input'/>
                            </div>
                            <div class='form-row'>  
                                <label>Radiator height</label>
                                <input id='default-radiator-height' type='number' step='any' min='0' placeholder='height' class='decimal round-corners-input'/>
                            </div>
                            <button type='button' class='btn-save'>Save</button>
                        </form>
                    </div>
                </div>
            </div>
            <div id='page-left-1' class='owl-page'>
                <div class='pageContentOuter'>
                    <div class='pageContent'>
                        <h2>Projects</h2>
                        <div class='form-row'>
                            <label>Create New</label>
                            <input id='new-project-title' type='text' placeholder='Project Title'/>
                        </div>
                        <input id='btn-create-project' type='button' value='Create'/>
                        <ul id='projects-list'>
                            <li class='project-item hidden'>
                                <input type='hidden' class='project-key' />
                                <input type='text' class='project-title' disabled="disabled" value='Project Title'/>
                                <div class='project-date-created'>Date Created</div>
                                <div class='project-controls hidden'>
                                    <button class='btn-select-project' type='button'>Select</button>
                                    <button class='btn-edit-project' type='button'>Edit</button>
                                    <button class='btn-delete-project' type='button'>Delete</button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id='page-room-1' class='owl-page room-page'>
                <div class='pageContentOuter'>
                  <div class='pageContent'>
                      <h2 class='room-title-heading' data-room-number="1">
                          <input name='room-title' type='text' placeholder='Room Name' class='room-title'/>
                      </h2>
                      <input type='hidden' class='room-key' />
                      <div class='results'>RESULTS</div>
                      <form class='room-form'> 
                          <div class='group-label'>
                              <span>Room</span>
                          </div>
                          <div class='form-group'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>L</label>
                                      <input name='room-length' class='room-length form-control decimal' type='number' step='any' min='0' placeholder='length' >
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='room-width' class='room-width form-control decimal' type='number' step='any' min='0' placeholder='width'>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='room-height' class='room-height form-control decimal' type='number' step='any' min='0' placeholder='height' >
                                  </div>
                              </div>
                          </div>

                          <div class='group-label'>
                              <span>Door</span>
                          </div>
                          <div class='form-group'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>#</label>
                                      <input name='door-qty' class='door-qty form-control integer' type='number' step='1' min='0' placeholder='quantity'>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='door-width' class='door-width form-control decimal' type='number' step='any' min='0' placeholder='width'>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='door-height' class='door-height form-control decimal' type='number' step='any' min='0' placeholder='width'>
                                  </div>
                              </div>
                          </div>

                          <div class='group-label'>
                              <span>Window</span>
                          </div>
                          <div class='form-group'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>#</label>
                                      <input name='window-qty' class='window-qty form-control integer' type='number' step='1' min='0' placeholder='quantity'/>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='window-width' class='window-width form-control decimal' type='number' step='any' min='0' placeholder='width' />
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='window-height' class='window-height form-control decimal' type='number' step='any' min='0' placeholder='height' />
                                  </div>
                              </div>
                          </div>

                          <div class='group-label'>
                              <span>Radiator</span>
                          </div>
                          <div class='form-row'>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>#</label>
                                      <input name='radiator-qty' class='radiator-qty form-control integer' type='number' step='any' min='0' placeholder='quantity'/>
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>W</label>
                                      <input name='radiator-width' class='radiator-width form-control decimal' type='number' step='any' min='0' placeholder='width' />
                                  </div>
                              </div>
                              <div class='input-pill'>
                                  <div class="input-pill-inner">
                                      <label class='control-label'>H</label>
                                      <input name='radiator-height' class='radiator-height form-control decimal' type='number' step='any' min='0' placeholder='height'/>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group baybreast-group'>
                              <div class='group-label'>
                                  <span>Bay or Breast</span>
                              </div>
                              <div class='input-block'>
                                  <div class='input-row'>
                                      <span class='positive-negative-first'>±</span>
                                      <input name='baybreast-width' class='baybreast-width decimal' type='number' step='any' placeholder='width'/>
                                      <input name='baybreast-depth' class='baybreast-depth decimal' type='number' step='any' min='0' placeholder='depth'/>
                                      <button type='button' class='btn-add-row'></button>
                                      <button type='button' class='btn-remove-row'></button>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group ceiling-adjust-group'>
                              <div class='group-label'>
                                  <span>Ceiling Adjusts</span>
                              </div>
                              <div class='form-row'>
                                  <span class='positive-negative-first'>±</span>
                                  <input name='ceiling-adjust-simple' class='ceiling-adjust-simple decimal' type='number' step='any' placeholder='amount'/>
                              </div>
                              <div class='input-block'>
                                  <div class='input-row'>
                                      <span class='positive-negative-first'>±</span>
                                      <input name='ceiling-adjust-dim1' class='ceiling-adjust-dim1 decimal' type='number' step='any' placeholder='amount'/>
                                      <input name='ceiling-adjust-dim2' class='ceiling-adjust-dim2 decimal' type='number' min='0' step='any' placeholder='amount'/>
                                      <button type='button' class='btn-add-row'></button>
                                      <button type='button' class='btn-remove-row'></button>
                                  </div>
                              </div>
                          </div>
                          
                          <div class='input-group wall-adjust-group'>
                              <div class='group-label'>
                                  <span>Wall Adjusts</span>
                              </div>
                              <div class='form-row'>
                                  <span class='positive-negative-first'>±</span>
                                  <input name='wall-adjust-simple' type='number' step='any' placeholder='amount' class='wall-adjust-simple decimal'/>
                              </div>
                              <div class='input-block'>
                                  <div class='input-row'>
                                      <span class='positive-negative-first'>±</span>
                                      <input name='wall-adjust-dim1' type='number' step='any' placeholder='amount' class='wall-adjust-dim1 decimal'/>
                                      <input name='wall-adjust-dim2' type='number' min='0' step='any' placeholder='amount' class='wall-adjust-dim2 decimal'/>
                                      <button type='button' class='btn-add-row'></button>
                                      <button type='button' class='btn-remove-row'></button>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group general-surface-group'>
                              <div class='group-label'>
                                  <span>General Surface</span>
                              </div>
                              <div class='input-block'>
                                  <div class="dropdown">
                                      <button class="dropdown-btn dropdown-toggle" type="button" data-toggle="dropdown">
                                          <span class='dropdown-text'>Dropdown</span>
                                          <input type='hidden' class='dropdown-value general-surface-key'/>
                                          <span class="caret"></span>
                                      </button>
                                      <ul class="dropdown-menu" role="menu">
                                          <li role='presentation'>
                                              <a role='menuitem' tabindex="-1" href="#">Menu Item</a>
                                          </li>
                                      </ul>
                                      <button type='button' class='btn-add-row'></button>
                                      <button type='button' class='btn-remove-row'></button>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>#</label>
                                          <input class='form-control general-surface-qty integer' name='general-surface-qty' type='number' step='1' min='0' placeholder='quantity'/>
                                      </div>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>W</label>
                                          <input class='form-control general-surface-width decimal' name='general-surface-width' type='number' step='any' min='0' placeholder='width'/>
                                      </div>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>H</label>
                                          <input class='form-control general-surface-height decimal' name='general-surface-height' type='number' step='any' min='0' placeholder='height'/>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <div class='input-group isolated-surface-group'>
                              <div class='group-label'>
                                  <span>Isolated Surface</span>
                              </div>
                              <div class='input-block'>
                                  <div class="dropdown">
                                      <button class="dropdown-btn dropdown-toggle" type="button" data-toggle="dropdown">
                                          <span class='dropdown-text'>Dropdown</span>
                                          <input type='hidden' class='dropdown-value isolated-surface-key'/>
                                          <span class="caret"></span>
                                      </button>
                                      <ul class="dropdown-menu" role="menu">
                                          <li role='presentation'>
                                              <a role='menuitem' tabindex="-1" href="#">Menu Item</a>
                                          </li>
                                      </ul>
                                      <button type='button' class='btn-add-row'></button>
                                      <button type='button' class='btn-remove-row'></button>
                                  </div>
                                  <div class='input-pill'>
                                      <div class='input-pill'>
                                          <div class="input-pill-inner">
                                              <label class='control-label'>#</label>
                                              <input class='form-control isolated-surface-qty integer' name='isolated-surface-qty' type='number' step='1' min='0' placeholder='quantity'/>
                                          </div>
                                      </div>
                                  </div>
                                  <div class='input-pill'>
                                      <div class="input-pill-inner">
                                          <label class='control-label'>L</label>
                                          <input class='form-control isolated-surface-length decimal' name='isolated-surface-length' type='number' step='any' min='0' placeholder='length'/>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <button type='button' id='btn-calculate' class='btn-calculate-room'>Calculate</button>
                          <button type='button' class='btn-save-room'>Save</button>
                          <button type='button' class='btn-delete-room'>Delete</button>

                      </form>
                    </div>
                </div>
            </div>
        </div>

        <div id='loadingDivOuter'>
            <span>LOADING</span>
            <div id='loadingDiv'>
                <img src='/static/loading.gif' alt='loading' />
            </div>
        </div>

        <div id='model-data'>
            <div id='model-projects'>{{ projects|safe }}</div>
            <div id='model-paints'>{{ paints|safe }}</div>
            <div id='model-rooms'>{{ rooms|safe }}</div>
            <div id='model-default-room'>{{ default_room|safe }}</div>
        </div>

    </body>

<script>
//Global variable to store current project data
var LOADING_START_TIME;
var CARO;
var CURRENT_PROJECT =   {};
var PROJECTS        =   JSON.parse($('#model-projects').text());
var SURFACE_TYPES   =   ['Ceilings','Walls','Doors','Windows','Radiators','Isolated Surfaces'];
var PAINTS          =   JSON.parse($('#model-paints').text());
var DEFAULT_ROOM    =   JSON.parse($('#model-default-room').text());
var ROOMS           =   JSON.parse($('#model-rooms').text());

var MODEL = {
    getDefaultRoom: function(){
        for(var i=0; i <= ROOMS.length - 1; i++){
            if(ROOMS[i].is_default == true){
                return ROOMS[i];
            }
        }
    },
    getRoomsForProject: function(project_key){
        var rooms = [];
        for(var i=0; i <= ROOMS.length - 1; i++){
            if(ROOMS[i].project == project_key){
                rooms.push(ROOMS[i]);
            }
        }
        return rooms;
    },
    getProject: function(project_key){
        var project = false;
        for(var i=0; i <= PROJECTS.length - 1; i++){ 
            if(PROJECTS[i].key == project_key){
                found = true;
                project = PROJECTS[i];
            }
        }
        return project;
    },
    updateProject: function(project){
        var found = false;
        for(var i=0; i <= PROJECTS.length - 1; i++){ 
            if(PROJECTS[i].key == project.key){
                found = true;
                PROJECTS[i] = project;
                for(var i=0; i < ROOMS.length - 1; i++){
                    if(ROOMS[i].project == project.key 
                      && $.inArray(ROOMS[i].key, project.rooms) == -1){
                        /* The project is no longer assocatiated with
                         the room, so remove the room -> project reference. */
                        ROOMS[i].project = '';
                    }
                }
            }
        }
        if(!found){
            PROJECTS.push(project);
        }
    },
    getRoom: function(room_key){
        for(var i=0; i <= ROOMS.length - 1; i++){
            if(ROOMS[i].key == room_key){
                return ROOMS[i];
            }
        }
    },
    updateRoom: function(room){
        var found = false;
        for(var i=0; i <= ROOMS.length - 1; i++){ 
            if(ROOMS[i].key == room.key){
                ROOMS[i] = room;
                found = true;
            }
        }
        if(!found){
          ROOMS.push(room);
        }
        //Add the room to the project
        if(room.project != ''){
            for(var i=0; i <= PROJECTS.length - 1; i++){ 
                if( PROJECTS[i].key == room.project 
                    && $.inArray(room.project, PROJECTS[i].rooms) == -1){
                        PROJECTS[i].rooms.push(room.key);
                }
            }
        }
    },
    deleteRoom: function(room_key){
        for(var i=0; i <= ROOMS.length - 1; i++){
            if(ROOMS[i].key == room_key){
                
                for(var j=0; j < PROJECTS.length - 1; j++){
                    /* Remove the project -> room reference. */
                    var idx = $.inArray(ROOMS[i].key, PROJECTS[j].rooms);
                    if(idx >= 0) PROJECTS[j].rooms.splice(idx, 1);
                }
                /* Remove the room */
                ROOMS.splice(i,1);
                break;
            }
        }
        return ROOMS;
    },
    getPaint: function(paint_key){
        for(var i=0; i <= PAINTS.length - 1; i++){
            if(PAINTS[i].key == paint_key){
                return PAINTS[i];
            }
        }
    },

};

//Add the projects to the list
function populateProjects(projects){
    $('.project-item:not(.hidden)').remove();
    for(var i=0; i<projects.length; i++){
        var $newBlock = $('.project-item:first').clone();
        $newBlock.find('.project-key').val( projects[i].key );
        $newBlock.find('.project-title').val( projects[i].title );
        $newBlock.find('.project-date-created').text(
            projects[i].date_created.split('.')[0].replace('T',' ')
        );
        $newBlock.removeClass('hidden');

        //Animate show/hide controls
        $newBlock.click( function(){ 
            var $controls = $(this).find('.project-controls');
            if($controls.css('display') == 'block'){
                $controls.animate(
                    {height:0},200,'swing',
                    function(){$controls.addClass('hidden');
                });
            }else{
                $controls.removeClass('hidden');
                $controls.animate(
                    {height:30},200,'swing',
                    function(){}
                );
            }
        });
        
        //Setup click events for the controls.
        $newBlock.find('.btn-select-project').click(function(event){
            selectProject( 
                $(this).closest('.project-item').find('.project-key').val()
            );
        });
        $newBlock.find('.btn-edit-project').click(function(event){
            console.log('edit');
            event.stopPropagation();
        });
        $newBlock.find('.btn-delete-project').click( deleteProject );

        $newBlock.appendTo('#projects-list'); 
    }
}

function selectProject(projectKey, reload){

    if(CURRENT_PROJECT.key == projectKey && reload != true){
        alert('Project already selected.');
        return;
    }

    if(CURRENT_PROJECT.key != projectKey){
        for(var i=0; i < PROJECTS.length; i++){
            if(PROJECTS[i].key == projectKey){
                CURRENT_PROJECT = PROJECTS[i];
                break;
            }
        }
    }

    $('#app-title').text('Paint Survey - ' + CURRENT_PROJECT.title);
    
    //Remove existing room pages
    if(CARO.owl.owlItems){
        while(CARO.owl.owlItems.length >= 4){
            CARO.removeItem(CARO.owl.owlItems.length - 1);
        }
    }

    //Add the room pages for this project
    if(CURRENT_PROJECT.rooms.length >= 1){
        var rooms = MODEL.getRoomsForProject(CURRENT_PROJECT.key);
        for(var i = 0; i <= rooms.length - 1; i++){
            CARO.addItem($('#owl-pages .owl-page.room-page').html());
            //Populate the room data in the inputs.
            initRoomPage(rooms[i]);
        }
    }else{
        //just add the default blank room.
        CARO.addItem($('#owl-pages .owl-page.room-page').html());
        initRoomPage();
    }
    CARO.next();
    
}

function createProject(){
    if($('#new-project-title').val().match(/\S/g)){
        doXhr({ 
            httpMethod: 'POST', 
            url: '/createproject',
            data: { projectTitle: $('#new-project-title').val() },
            dataType: 'json',
            successFunc: function(data){ 
                PROJECTS = data;
                populateProjects(PROJECTS);
                $('#new-project-title').val('');
            }
        });
    }else{
        alert('Project title can not be blank!');
    }
}

function deleteProject(){

    var project_key = $(this).closest('.project-item').find('.project-key').val();

    doXhr({
        httpMethod: 'POST', 
        url: '/deleteproject',
        data: { project_key: project_key },
        dataType: 'json',
        successFunc: function(data){
            PROJECTS = data;
            //TODO:update any orphan rooms.
            populateProjects(PROJECTS);
        }
    });
}

function getRoomGroupData($page){

    var results = {
        'bayBreastVals':[],
        'ceilingAdjustVals':[],
        'wallAdjustVals':[],
        'genSurfaceVals':[],
        'isolSurfaceVals':[],
        toString: function(){
            var str = '';
            str += 'bayBreastVals [' + this.bayBreastVals + ']\n';
            str += 'ceilingAdjustVals [' + this.ceilingAdjustVals + ']\n';
            str += 'wallAdjustVals [' + this.wallAdjustVals + ']\n';
            str += 'genSurfaceVals [' + this.genSurfaceVals + ']\n';
            str += 'isolSurfaceVals [' + this.isolSurfaceVals + ']\n';
            return str;
        }
    };

    var getf = function(inputElem, ancestor){
        $parent = (ancestor != null) ? $(ancestor) : $page;
        var floatVal = parseFloat($parent.find(inputElem).val());
        return Math.abs(floatVal) >= 0 ? floatVal : 0; 
    }

    $page.find('.baybreast-group .input-block').each( function(index, elem){
        results.bayBreastVals.push([ 
            getf('.baybreast-depth', elem), 
            getf('.baybreast-width', elem) 
        ]);
    });

    $page.find('.ceiling-adjust-group .input-block').each( function(index, elem){
        results.ceilingAdjustVals.push([ 
            getf('.ceiling-adjust-dim1', elem), 
            getf('.ceiling-adjust-dim2', elem) 
        ]);
    });

    $page.find('.wall-adjust-group .input-block').each( function(index, elem){
        results.wallAdjustVals.push([
            getf('.wall-adjust-dim1', elem), 
            getf('.wall-adjust-dim2', elem) 
        ]);
    });

    $page.find('.general-surface-group .input-block').each( function(index, elem){
console.log('gen surf key ' + $(elem).find('.general-surface-key').val());
        results.genSurfaceVals.push([
            $(elem).find('.general-surface-key').val(),
            getf('.general-surface-qty', elem),
            getf('.general-surface-width', elem),
            getf('.general-surface-height', elem) 
        ]);
    });

    $page.find('.isolated-surface-group .input-block').each( function(index, elem){
        results.isolSurfaceVals.push([
            $(elem).find('.isolated-surface-key').val(),
            getf('.isolated-surface-qty', elem),
            getf('.isolated-surface-length', elem),
        ]);
    });

    return results;
}

function calculateWorkForRoom(event){

    var $roomForm = $(event.target).closest('.room-form');
    //Validate input first.
    if(!$roomForm.validate({ 
            errorPlacement: function(error, element) {
                error.insertAfter(element.closest('.input-pill'));
            }
        }).form()){
        return;
    }

    var getf = function(descendant, ancestor){
        var $elem = $(event.target).closest('.pageContent'); 
        $elem = (ancestor != null) ? $(ancestor) : $elem;
        var floatVal = parseFloat($elem.find(descendant).val());
        return Math.abs(floatVal) >= 0 ? floatVal : 0; 
    }
    
    var roomLength      =   getf('.room-length:first');
    var roomWidth       =   getf('.room-width:first');
    var roomHeight      =   getf('.room-height:first');
    var doorQty         =   getf('.door-qty:first');
    var doorWidth       =   getf('.door-width:first');
    var doorHeight      =   getf('.door-height:first');
    var windowQty       =   getf('.window-qty:first');
    var windowWidth     =   getf('.window-width:first');
    var windowHeight    =   getf('.window-height:first');
    var radiatorQty     =   getf('.radiator-qty:first');
    var radiatorWidth   =   getf('.radiator-width:first');
    var radiatorHeight  =   getf('.radiator-height:first');
    var ceilingAdjust   =   getf('.ceiling-adjust-simple');
    var wallAdjust      =   getf('.wall-adjust-simple');

    var baybreastWall = 0;
    var baybreastCeiling = 0;
    var baybreastSkirting = 0;

    var genSurfSpace = 0;
    var genSurfHours = 0;

    var isolSurfSpace = 0;
    var isolSurfHours = 0;

    var roomData = getRoomGroupData($roomForm);
    
    for(var i = 0; i <= roomData.bayBreastVals.length - 1; i++){
        var bbDepth = roomData.bayBreastVals[i][0];
        var bbWidth = roomData.bayBreastVals[i][1];
        if(Math.abs(bbDepth * bbWidth) > 0){
            baybreastWall += (2 * bbDepth * roomHeight);
            baybreastCeiling += (bbWidth * bbDepth);
            baybreastSkirting += (2 * bbDepth);
        }
    }
    for(var i = 0; i <= roomData.ceilingAdjustVals.length - 1; i++){
        var dim1 = roomData.ceilingAdjustVals[i][0];
        var dim2 = roomData.ceilingAdjustVals[i][1];
        if(Math.abs(dim1 * dim2) > 0) ceilingAdjust += (dim1 * dim2);
    }
    for(var i = 0; i <= roomData.wallAdjustVals.length - 1; i++){
        var dim1 = roomData.wallAdjustVals[i][0];
        var dim2 = roomData.wallAdjustVals[i][1];
        if(Math.abs(dim1 * dim2) > 0) wallAdjust += (dim1 * dim2);
    }
    for(var i = 0; i <= roomData.genSurfaceVals.length - 1; i++){
        var prodRate = MODEL.getPaint(roomData.genSurfaceVals[i][0]).prod_rate;
        var quantity = roomData.genSurfaceVals[i][1];
        var dim1 = roomData.genSurfaceVals[i][2];
        var dim2 = roomData.genSurfaceVals[i][3];
        if(Math.abs(quantity * dim1 * dim2) > 0) {
            genSurfSpace += (quantity * dim1 * dim2);
            genSurfHours += ((quantity * dim1 * dim2) / prodRate);
        }
    }
    for(var i = 0; i <= roomData.isolSurfaceVals.length - 1; i++){
        var prodRate = MODEL.getPaint(roomData.isolSurfaceVals[i][0]).prod_rate;
        var quantity = roomData.isolSurfaceVals[i][1];
        var dim1 = roomData.isolSurfaceVals[i][2];
        if(Math.abs(quantity * dim1) > 0) {
            isolSurfSpace += (quantity * dim1);
            isolSurfHours += ((quantity * dim1) / prodRate);
        }
    }

    var doorSpace =     doorQty * doorWidth * doorHeight;
    var doorFrame =     (doorHeight * 2 + doorWidth) * doorQty;
    var windowSpace =   windowQty * windowWidth * windowHeight;
    var ceilingSpace =  (roomLength * roomWidth) + baybreastCeiling + ceilingAdjust; 
    var wallSpace =     (roomLength + roomWidth) * 2 * roomHeight - doorSpace - windowSpace + baybreastWall + wallAdjust; 
    var skirtingSpace = (roomLength + roomWidth) * 2 - (doorWidth * doorQty) + baybreastSkirting;
    var radiatorSpace = radiatorQty * radiatorWidth * radiatorHeight;

    var getRate = function(surface_type){
        var key = $('#select-' + surface_type + '-spec').val();
        var paint = MODEL.getPaint(key);
        return parseFloat(paint.prod_rate);
    };

    var tableData = [
        { title: 'CEILING',     amount: ceilingSpace,    units: 'm2', hours: ceilingSpace / getRate('ceilings') },
        { title: 'WALL',        amount: wallSpace,       units: 'm2', hours: wallSpace / getRate('walls') },
        { title: 'DOOR AREA',   amount: doorSpace,       units: 'm2', hours: doorSpace / getRate('doors') },
        { title: 'DOOR FRAME',  amount: doorFrame,       units: 'm',  hours: doorFrame / getRate('isolated-surfaces') },
        { title: 'WINDOW',      amount: windowSpace,     units: 'm2', hours: windowSpace / getRate('windows') },
        { title: 'RADIATOR',    amount: radiatorSpace,   units: 'm2', hours: radiatorSpace / getRate('radiators') },
        { title: 'SKIRTING',    amount: skirtingSpace,   units: 'm2', hours: skirtingSpace / getRate('isolated-surfaces') }, 
        { title: 'GENERAL SURFACE',    amount: genSurfSpace,   units: 'm2', hours: genSurfHours },
        { title: 'ISOLATED SURFACE',    amount: isolSurfSpace,   units: 'm', hours: isolSurfHours }
    ];

    var $resultsElem = $(event.target).closest('.pageContent').find('.results:first');
    $resultsElem.html(buildResultsTable(tableData));
    $resultsElem.fadeIn(500);

    $("html, body").animate({ scrollTop: 0 }, "slow");
}

function buildResultsTable(tableData){
    var results = '<table><tr><th>Part</th><th>Amount</th><th></th><th>Hours</th></tr>';
    var totalHours = 0;
    
    for (i = 0; i < tableData.length; ++i) {
        obj = tableData[i];
        results += '<tr>';
        for (var key in obj){
            if (obj.hasOwnProperty(key)) {
                var val = 0;
                var cssClass = 'class="tdRightAlign"';
                if(key == 'amount' ){
                    val = roundAndFix(obj[key], 2);
                }else if(key == 'hours'){
                    val = roundAndFix(obj[key], 2);
                    totalHours += parseFloat(val);
                }else{
                    val = obj[key];
                    cssClass = '';
                }
                results += '<td ' + cssClass + '>' + val + '</td>';
            }
        }
        results += '</tr>';
    }

    results += '<tr class="rowTotalHours"><td>TOTAL:</td><td></td><td></td><td class="tdRightAlign">' + totalHours.toFixed(2) + '</td></tr>';
    results += '</table>';
    return results;
}

function roundAndFix (number, precision) {
    var multiplier = Math.pow (10, precision);
    var result = Math.round (number * multiplier) / multiplier;
    return result.toFixed(precision);
}

function keydownDecimalInput(event){

    var $elem = $(this);

    // Allow: backspace, delete, tab, escape, enter, ctrl+A
    if ($.inArray(event.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
         // Allow: Ctrl+A
        (event.keyCode == 65 && event.ctrlKey === true) || 
         // Allow: home, end, left, right
        (event.keyCode >= 35 && event.keyCode <= 39)) {
             // let it happen, don't do anything
             return;
    }

    //If the input allows negative numbers allow '-' minus sign.
    if(event.keyCode == 189){
        if(!$elem.attr('min') || parseFloat($elem.attr('min')) < 0){
            //if already minus sign or number before, prevent.
            if(/[0-9\-]/.test($elem.val())) {
                event.preventDefault();
            }
            return
        }
    }

    //If not number or decimal point, prevent.
    if(/[^0-9]/.test(String.fromCharCode(event.keyCode))
      && event.keyCode != 190 ){
        event.preventDefault();
        return;
    };

    //if already decimal point, prevent.
    if(event.keyCode == 190 && /\./.test(this.value)) {
        event.preventDefault();
        return;
    }
}

function keyupDecimalInput(event){
    var $elem = $(this);
    if($elem.val().length > 0){
        if($elem.val() > 0){
            $elem.css('color','black');
        }else{
            $elem.css('color','red');
        }
    }
    
}

function keydownIntegerInput(event){
    // Allow: backspace, delete, tab, escape, enter, ctrl+A
    if ($.inArray(event.keyCode, [46, 8, 9, 27, 13, 110]) !== -1 ||
         // Allow: Ctrl+A
        (event.keyCode == 65 && event.ctrlKey === true) || 
         // Allow: home, end, left, right
        (event.keyCode >= 35 && event.keyCode <= 39)) {
             // let it happen, don't do anything
             return;
    }

    //If not number, prevent
    if(/[0-9]/.test(String.fromCharCode(event.keyCode))) return;

    event.preventDefault();  
}

function blurDecimal(){
    //Enforce 2 decimal places.
    if(this.value.trim() == '.') this.value = '0.00';
    if(this.value.length >= 1 && Math.abs(parseFloat(this.value)) > 0){
        this.value = parseFloat(this.value).toFixed(2);
    }else{
        this.value = '';
    }
    //Set red color for negative values
    var $elem = $(this);
    if($elem.val().length > 0){
        if($elem.val() > 0){
            $elem.css('color','black');
        }else{
            $elem.css('color','red');
        }
    }
}

function blurInputFocus(event){

    var tagName = event.target.tagName.toLowerCase();
    if(tagName != 'input' && tagName != 'select'){
        $(':focus').blur();
    }
    var $elem = $(event.target);
    if($elem.hasAncestor('.dropdown-menu') == false
      && $elem.hasAncestor('.dropdown-btn') == false){
       $('.dropdown.open').removeClass('open');
    }
}

function roomDefaultsChange(){
    //Update the corresponding input on the room 1 screen.
    var $elem = $(this);
    $('.' + $elem.attr('id').replace('default-','')).val($elem.val());
}

function switchSign(event){
    $btn = $(this);
    $input = $btn.next('input[type="number"]');
    $input.val(-1 * $input.val());
    $input.blur();
}

function initOwlCarousel(){
    //Add the pages into the CARO
    $('#owl-pages .owl-page').each(function(){
        var $page = $(this);
        if($page.hasClass('room-page') == false){
            $page.appendTo('#owl-carousel');
        }
    })
    $('#owl-carousel').owlCarousel(
        { 
            navigation : true, // Show next and prev buttons
            slideSpeed : 300,
            paginationSpeed : 400,
            singleItem: true,
            afterInit : function(elem){
              var that = this;
              that.owlControls.prependTo(elem);
              this.jumpTo(2);
            }
        }
    );
    CARO = $('#owl-carousel').data('owlCarousel');
}

function toggleDropDown(){
  console.log('toggleDropDown');
    var $dropdown = $(this).closest('.dropdown');
    var c = 'open';

    if($dropdown.hasClass(c)){
        $dropdown.removeClass(c);
    }else{
        $dropdown.addClass(c);
    };
}

function selectDropDownItem(){
    //find the closest drop down and set the value of the hidden input.
    var $clickedItem = $(this);
    var $dropdown = $clickedItem.closest('.dropdown');
    $dropdown.find('.dropdown-value').val( $clickedItem.data('value') );
    $dropdown.find('.dropdown-text').text( $clickedItem.text() );
    $dropdown.removeClass('open');
    return false;
}

function initDropdown(elem){

    var $elem = $(elem);
    var selectedValue = $elem.find('.dropdown-value').val();
    var dropdownText = $elem.find('.dropdown-text').text().toLowerCase();

    if (dropdownText == 'dropdown' || dropdownText == 'menu item' 
      || typeof selectedValue === 'undefined' || selectedValue == ''){
console.log('init dropdown');
        var defaultItem = $elem.find('.dropdown-menu a:first');
        $elem.find('.dropdown-value').val( defaultItem.data('value') );
        $elem.find('.dropdown-text').text( defaultItem.text() );
    }
    
    $elem.find('.dropdown-btn').unbind('click');
    $elem.find('.dropdown-btn').click( toggleDropDown );
    $elem.find('.dropdown-menu a').bind( 'click touchstart', selectDropDownItem );

}

function initDropdowns(context){
    if(context == null) context = $('html');
    $(context).find('.dropdown').each( function(index, elem){
        console.log('x');
        initDropdown(elem);
    });
}

function swapElements(elm1, elm2) {
    var parent1, next1,
        parent2, next2;

    parent1 = elm1.parentNode;
    next1   = elm1.nextSibling;
    parent2 = elm2.parentNode;
    next2   = elm2.nextSibling;

    parent1.insertBefore(elm2, next1);
    parent2.insertBefore(elm1, next2);
}

function showEditSpecView(){
    var $clickedButton = $(this);
    
    var surface_type = $clickedButton.closest('.spec-item-block')
                          .find('.spec-item-title').text();
    $('#spec-surface-type').val(surface_type);

    //For each paint of this surface type, build the edit inputs.
    $.each(PAINTS, function(i, paint) {  
        if (paint.surface_type.toLowerCase() == surface_type.toLowerCase()) {
            var $newBlock = $('#form-edit-spec .input-block:first').clone();
            $newBlock.find('input.spec-item-key').val(paint.key);
            $newBlock.find('input.spec-item-order').val(paint.order);
            $newBlock.find('input.spec-item-name').val(paint.name);
            $newBlock.find('input.spec-item-rate').val(paint.prod_rate);
            $newBlock.removeClass('hidden');
            $newBlock.insertAfter('#form-edit-spec .input-block:last');
            $btnRemove = $newBlock.find('.btn-remove-row:first');
            $btnRemove.css('display','block');
            $btnRemove.click(function(event){ $(event.target).closest('.input-block').remove(); });
            $btnReorderUp = $newBlock.find('.btn-reorder-item-up');
            $btnReorderDown = $newBlock.find('.btn-reorder-item-down');
            $btnReorderUp.click( function(){ 
                var $thisBlock = $(this).closest('.input-block');
                var $partnerBlock = $thisBlock.prev('.input-block:not(.hidden)');
                if(typeof $partnerBlock.get(0) != 'undefined'){
                    swapElements($thisBlock.get(0), $partnerBlock.get(0));
                    var order1 = $thisBlock.find('input.spec-item-order').val();
                    var order2 = $partnerBlock.find('input.spec-item-order').val();
                    $thisBlock.find('input.spec-item-order').val(order2)
                    $partnerBlock.find('input.spec-item-order').val(order1);
                }
            });
            $btnReorderDown.click( function(){ 
                var $thisBlock = $(this).closest('.input-block');
                var $partnerBlock = $thisBlock.next('.input-block:not(.hidden)');
                if(typeof $partnerBlock.get(0) != 'undefined'){
                    swapElements($thisBlock.get(0), $partnerBlock.get(0));
                    var order1 = $thisBlock.find('input.spec-item-order').val();
                    var order2 = $partnerBlock.find('input.spec-item-order').val();
                    $thisBlock.find('input.spec-item-order').val(order2)
                    $partnerBlock.find('input.spec-item-order').val(order1);
                } 
            });
        }
    });
    
    initDecimalInputs();

    $('#form-view-spec').fadeOut('fast', function(){
        $('#form-edit-spec').fadeIn('fast');
    });
}

function getPaints(){
    doXhr({
        httpMethod: 'GET',
        url: '/getpaints',
        dataType: 'json',
        successFunc: function(data){ PAINTS = data; }
    });
}

function populateSpecDropdowns(){
    $('.spec-item-block:not(.hidden)').remove();

    //Display view, for each surface type, build the dropdown menus.
    for(var i = 0; i < SURFACE_TYPES.length; i++){
        $newBlock = $('.spec-item-block:first').clone();
        $newBlock.find('.spec-item-title').text( SURFACE_TYPES[i] );
        $.each(PAINTS, function(j, paint) {
            if (paint.surface_type == SURFACE_TYPES[i]) {
                $newBlock.find('.dropdown-value').attr('id',
                    'select-' + paint.surface_type.toLowerCase().replace(' ', '-') + '-spec');
                $newBlock.find('ul.dropdown-menu').append(
                    '<li><a role="menuitem" data-value="' + paint.key + '" >' 
                    + paint.name + ' (' + paint.prod_rate + ') </a></li>'
                );
            }
        });
        $newBlock.removeClass('hidden');
        $newBlock.appendTo('#form-view-spec');
    }
    $('.btn-edit-spec').click( showEditSpecView );
    initDropdowns($('#form-view-spec'));
}

function initSpecificationPage(){
    populateSpecDropdowns();
    $('#form-edit-spec .btn-save').click( onSpecSave );
    $('#form-edit-spec .btn-cancel').click( fadeToViewSpec );
}

function fadeToViewSpec(){
    $('#form-edit-spec').fadeOut('fast', function(){
        $('#form-edit-spec .input-block:not(.hidden)').remove();
        populateSpecDropdowns();
        $('#form-view-spec').fadeIn('fast');
    });
}

function onSpecSave(){

    var arrSpecItemData = [];
    var specItemNames = [];
    var duplicates = [];

    /* Prevent duplicate spec-item-names for this surface type */
    $('#form-edit-spec .input-block:not(.hidden) .spec-item-name').each(function(index, elem) {
        var inputVal = $(elem).val().trim();
        if($.inArray(inputVal, specItemNames) == -1) { //Not found
            specItemNames.push(inputVal);
        } else {
            duplicates.push(inputVal);
        }
    });

    if(duplicates.length >= 1){
      alert("Can not save, duplicate value(s) found: " + duplicates.toString());
      return;
    }

    /* Build up the json data making save call */
    $('#form-edit-spec .input-block:not(.hidden)').each( function(index, elem){
        var $elemBlock = $(elem);
        arrSpecItemData.push({ 
            key:          $elemBlock.find('.spec-item-key').val(),
            order:        $elemBlock.find('.spec-item-order').val(),
            name:         $elemBlock.find('.spec-item-name').val().trim(),
            prod_rate:    $elemBlock.find('.spec-item-rate').val(),
            surface_type: $('#spec-surface-type').val()
        });
    });

    doXhr({
        httpMethod: 'POST',
        url: '/savespec',
        data: { 
          surface_type: $('#spec-surface-type').val(), 
          paints: JSON.stringify(arrSpecItemData) 
        },
        dataType: 'json',
        successFunc: function(data){ 
            PAINTS = data; 
            fadeToViewSpec();
        }
    });
    
}

function deleteRoom(room_key){

    //Do an ajax call to save the room data
    doXhr({
        httpMethod: 'POST',
        url: '/deleteroom',
        data: { room_key: room_key },
        successFunc: function(data){
                          MODEL.deleteRoom(room_key);
                          CURRENT_PROJECT = data;
                          selectProject(CURRENT_PROJECT.key, true);
                      }
    });

}

function saveRoom(room, keyElem){
    //Do an ajax call to save the room data
    doXhr({
        httpMethod: 'POST',
        url: '/saveroom',
        data: { room: JSON.stringify( room ) },
        dataType: 'json',
        successFunc:  function(data, status){
                          if(status == 'success'){
                              alert('Room saved.');
                              MODEL.updateRoom(data);
                              if(keyElem != null) {
                                  $(keyElem).val(data.key);
                              }
                          }else{
                              alert('Error saving room.');
                          }
                          $('html, body').animate({ scrollTop: 0 }, 'slow');
                      }
    });

}

function initRoomDefaultsPage(){
    
    var drm = DEFAULT_ROOM;

    $('#default-room-key'         ).val( drm.key );
    $('#default-room-height'      ).val( drm.room_height );
    $('#default-door-width'       ).val( drm.door_width );
    $('#default-door-height'      ).val( drm.door_height );
    $('#default-window-width'     ).val( drm.window_width );
    $('#default-window-height'    ).val( drm.window_height );
    $('#default-radiator-width'   ).val( drm.radiator_width );
    $('#default-radiator-height'  ).val( drm.radiator_height );
    
    $('#form-room-defaults input[type="number"]').change( roomDefaultsChange );

    $('#form-room-defaults .btn-save').click( function(){
        saveRoom({
            key: $('#default-room-key').val(),
            name: 'Default Room',
            room_width: 0,
            room_length: 0,
            room_height: parseFloat($('#default-room-height').val()),
            door_quantity: 0,
            door_width: parseFloat($('#default-door-width').val()),
            door_height: parseFloat($('#default-door-height').val()),
            window_quantity: 0,
            window_width: parseFloat($('#default-window-width').val()),
            window_height: parseFloat($('#default-window-height').val()),
            radiator_quantity: 0,
            radiator_width: parseFloat($('#default-radiator-width').val()),
            radiator_height: parseFloat($('#default-radiator-height').val()),
            group_items: '',
            is_default: true,
            project: ''
        });
    });      
}

function initProjectsPage(){
    populateProjects(PROJECTS);
    $('#btn-create-project').click( createProject );
}

function initRoomPage(room){
    var getf = function(elemId){
        return parseFloat($(elemId).val()).toFixed(2);
    }

    var $page = $('.owl-item:last');

    //Use the default room settings if room object not passed in.
    if(room == null){
        room = {  
            "name": 'Default Room',
            "room_length": '',
            "room_width": '',
            "room_height": getf('#default-room-height'),
            "door_quantity": '',
            "door_height": getf('#default-door-height'),    
            "door_width": 0.9,   
            "radiator_quantity": '',
            "radiator_height": getf('#default-radiator-height'),
            "radiator_width": getf('#default-radiator-width'),           
            "window_width": getf('#default-window-width'),
            "window_height": getf('#default-window-height'),     
            "window_quantity": ''
        }
    } 

    $page.find('.room-key')               .val(room.key);
    $page.find('.room-title')             .val(room.name);
    $page.find('.room-height')            .val(room.room_height);
    $page.find('.room-width')             .val(room.room_width);
    $page.find('.room-length')            .val(room.room_length);
    $page.find('.door-qty')               .val(room.door_quantity);
    $page.find('.door-width')             .val(room.door_width);
    $page.find('.door-height')            .val(room.door_height);
    $page.find('.window-qty')             .val(room.window_quantity);
    $page.find('.window-width')           .val(room.window_width);
    $page.find('.window-height')          .val(room.window_height);
    $page.find('.radiator-qty')           .val(room.radiator_quantity);
    $page.find('.radiator-width')         .val(room.radiator_width);
    $page.find('.radiator-height')        .val(room.radiator_height);
    $page.find('.ceiling-adjust-simple')  .val(room.ceiling_adjust_simple);
    $page.find('.wall-adjust-simple')     .val(room.wall_adjust_simple);
    
    $page.find('.positive-negative-first,.positive-negative-second').click( switchSign );

    //TODO: build input blocks and set the values for each group item.
    if(room.group_items != null){
        
        for(var i = 0; i <= room.group_items.bayBreastVals.length - 1; i++){
            
            if(i >= 1) addInputBlock( $page.find('.baybreast-group .btn-add-row:last') );
            var $block = $page.find('.baybreast-group .input-block:last');
            $block.find('.baybreast-width').val( room.group_items.bayBreastVals[i][0] );
            $block.find('.baybreast-depth').val( room.group_items.bayBreastVals[i][1] );
        }
        
        for(var i = 0; i <= room.group_items.ceilingAdjustVals.length - 1; i++){
            
            if(i >= 1) addInputBlock( $page.find('.ceiling-adjust-group .btn-add-row:last') );
            var $block = $page.find('.ceiling-adjust-group .input-block:last');
            $page.find('.ceiling-adjust-dim1').val( room.group_items.ceilingAdjustVals[i][0] );
            $page.find('.ceiling-adjust-dim2').val( room.group_items.ceilingAdjustVals[i][1] );
        }
        
        for(var i = 0; i <= room.group_items.wallAdjustVals.length - 1; i++){
            
            if(i >= 1) addInputBlock( $page.find('.wall-adjust-group .btn-add-row:last') );
            $page.find('.wall-adjust-dim1').val( room.group_items.wallAdjustVals[i][0] );
            $page.find('.wall-adjust-dim2').val( room.group_items.wallAdjustVals[i][1] );        
        }
        
        for(var i = 0; i <= room.group_items.genSurfaceVals.length - 1; i++){
            
            if(i >= 1) addInputBlock( $page.find('.general-surface-group .btn-add-row:last') );
            var paint = MODEL.getPaint(room.group_items.genSurfaceVals[i][0]);
            var $block = $page.find('.general-surface-group .input-block:last');
            $block.find('.dropdown-value').val( paint.key );
            $block.find('.dropdown-text').text( paint.name + ' (' + paint.prod_rate + ')' );
            $block.find('.general-surface-qty').val( room.group_items.genSurfaceVals[i][1] );
            $block.find('.general-surface-width').val( room.group_items.genSurfaceVals[i][2] );
            $block.find('.general-surface-height').val( room.group_items.genSurfaceVals[i][3] );
        }
        
        for(var i = 0; i <= room.group_items.isolSurfaceVals.length - 1; i++){
            
            if(i >= 1) addInputBlock( $page.find('.isolated-surface-group .btn-add-row:last') );
            var paint = MODEL.getPaint(room.group_items.isolSurfaceVals[i][0]);
            var $block = $page.find('.isolated-surface-group .input-block:last');
            $block.find('.dropdown-value').val( paint.key );
            $block.find('.dropdown-text').text( paint.name + ' (' + paint.prod_rate + ')' );
            $block.find('.isolated-surface-qty').val( room.group_items.isolSurfaceVals[i][1] );
            $block.find('.isolated-surface-length').val( room.group_items.isolSurfaceVals[i][2] );
        }
    }

    //Add the paint menu items to the general surface dropdowns
    var $dropdown = $page.find('.general-surface-group ul.dropdown-menu');
    $dropdown.empty();
    $.each(PAINTS, function(j, paint) {
        if (paint.surface_type == 'Doors') {
            $dropdown.append(
                '<li><a role="menuitem" data-value="' + paint.key + '" >' 
                + paint.name + ' (' + paint.prod_rate + ') </a></li>'
            );
        }
    });

    //Add the paint menu items to the isolated surface dropdowns
    var $isolDropdownMenu = $page.find('.isolated-surface-group ul.dropdown-menu');
    $isolDropdownMenu.empty();
    $.each(PAINTS, function(j, paint) {
        if (paint.surface_type == 'Isolated Surfaces') {
            $isolDropdownMenu.append(
                '<li><a role="menuitem" data-value="' + paint.key + '" >' 
                + paint.name + ' (' + paint.prod_rate + ') </a></li>'
            );
        }
    });

    $page.find('.btn-calculate-room').click( calculateWorkForRoom );
    $page.find('.btn-delete-room').click( onDeleteRoomClick );
    $page.find('.btn-save-room').click( onSaveRoomClick );

    initIntegerInputs();
    initDecimalInputs();
    initDropdowns($page);
    initAddInputBlockButtons();

}

function onDeleteRoomClick(){
    if(CURRENT_PROJECT.rooms.length >= 1){
        deleteRoom($(this).closest('.owl-item').find('.room-key').val());
    }else{
        alert('Room not saved yet.');
    }
}

function onSaveRoomClick(){

    var $page = $(this).closest('.owl-item');
    var getf = function(elemId){
        return parseFloat($page.find(elemId).val());
    }

    groupItems = getRoomGroupData($page);
    console.log('groupItems ' + groupItems.toString());

    if(isObjectEmpty(CURRENT_PROJECT)){
        alert('Please select a project first.');
    }else{
        saveRoom({
            key:                    $page.find('.room-key').val(),
            name:                   $page.find('.room-title').val(),
            room_length:            getf('.room-length'),
            room_width:             getf('.room-width'),
            room_height:            getf('.room-height'),
            door_quantity:          getf('.door-qty'),
            door_width:             getf('.door-width'),
            door_height:            getf('.door-height'),
            window_quantity:        getf('.window-qty'),
            window_width:           getf('.window-width'),
            window_height:          getf('.window-height'),
            radiator_quantity:      getf('.radiator-qty'),
            radiator_width:         getf('.radiator-width'),
            radiator_height:        getf('.radiator-height'),
            ceiling_adjust_simple:  getf('.ceiling-adjust-simple'),
            wall_adjust_simple:     getf('.wall-adjust-simple'),
            group_items:            groupItems,
            is_default:             false,
            project:                CURRENT_PROJECT.key
        }, '.room-key');
    }

}

function initIntegerInputs(){
    $('.integer').keydown( keydownIntegerInput );
}

function initDecimalInputs(){
    $('.decimal').keydown( keydownDecimalInput );
    $('.decimal').keyup( keyupDecimalInput );
    $('.decimal').bind( 'blur', blurDecimal );
    $('.decimal').blur();
}

function svgEl(tagName) {
    return document.createElementNS("http://www.w3.org/2000/svg", tagName);
}

function addSvgElems(containerIds, svgElemData){
    for(var i=0;i<containerIds.length;i++){
        var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        $(containerIds[i]).append($(svg).attr({ 'width':30, 'height':30 }));
        for(var j=0;j<svgElemData.length;j++){
            $(containerIds[i] + ' > svg').append(
              $(svgEl(svgElemData[j]['tagName'])).attr(svgElemData[j])
            );
        }
    }
}

function addSvgButtons(){

    addSvgElems(
        [ '#btn-add-spec-item','.btn-add-row' ],
        [
          { 'tagName':'circle', cx: 15, cy: 15, r: 15, 'fill': 'blue'},
          { 'tagName':'polygon','points':'12,6 18,6 18,12 24,12 24,18 18,18 18,24 12,24 12,18 12,18 6,18 6,12 12,12', 'fill':'white' }
        ]
    );

    //Init 'remove block' svg button icons
    addSvgElems(
        [ '.btn-remove-row' ],
        [
          { 'tagName':'circle', cx: 15, cy: 15, r: 15, 'fill': 'red'},
          { 'tagName':'polygon','points':'6,12 24,12 24,18 6,18 6,12', 'fill':'white' }
        ]
    );

    //Init item reorder up button icons
    addSvgElems(
        [ '.btn-reorder-item-up' ],
        [
          { 'tagName':'circle', cx: 15, cy: 15, r: 15, 'fill': 'black'},
          { 'tagName':'polygon','points':'15,7 23,20 7,20', 'fill':'white' }
        ]
    );

    //Init item reorder down button icons
    addSvgElems(
        [ '.btn-reorder-item-down' ],
        [
          { 'tagName':'circle', cx: 15, cy: 15, r: 15, 'fill': 'black'},
          { 'tagName':'polygon','points':'15,23 23,10 7,10', 'fill':'white' }
        ]
    );

}

function addInputBlock(context){

      //Buttons to add groups of inputs.
      //Set up events for various inputs in the new block if present.
      var $group = $(context).closest('.input-group');
      var $newBlock = $group.find('.input-block:last').clone();

      $newBlock.find('input').val('');
      $newBlock.find('.btn-add-row:first').remove();
      $newBlock.find('input.decimal').keydown( keydownDecimalInput );
      $newBlock.find('input.decimal').blur( blurDecimal );
      $newBlock.find('.dropdown').removeClass('open');
      $newBlock.find('.positive-negative-first,.positive-negative-second').click( switchSign );
      $newBlock.removeClass('hidden');
      $newBlock.insertAfter($group.find('.input-block:last'));
      $btnRemove = $newBlock.find('.btn-remove-row:first');
      $btnRemove.css('display','block');
      $btnRemove.click(function(event){ 
          $(event.target).closest('.input-block').remove(); 
      });
      initDropdowns($newBlock);
}

function initAddInputBlockButtons(){

    $('#btn-add-spec-item,.btn-add-row').click( function(){
        addInputBlock(this);
    });
}

$(document).ready(function() {

    initOwlCarousel();
    initSpecificationPage();
    initRoomDefaultsPage();
    initProjectsPage();

    $('body').bind('touchstart click', blurInputFocus );
    addSvgButtons();

    initIntegerInputs();
    initDecimalInputs();
    initAddInputBlockButtons();
    //initDropdowns();
});

function isObjectEmpty(object)
{
    if ('object' !== typeof object) {
        throw new Error('Object must be specified.');
    }

    if (null === object) {
        return true;
    }

    if ('undefined' !== Object.keys) {
        // Using ECMAScript 5 feature.
        return (0 === Object.keys(object).length);
    } else {
        // Using legacy compatibility mode.
        for (var key in object) {
            if (object.hasOwnProperty(key)) {
                return false;
            }
        }
        return true;
    }
}

function doXhr(params) {

  var $loading = $('#loadingDivOuter');
  var success = false;

  return $.ajax({
      url:        params.url,
      type:       params.httpMethod,
      data:       params.data,
      dataType:   params.dataType,
      beforeSend: function(){
          LOADING_START_TIME = new Date($.now());
          $loading.center();
          $loading.show();
      },
      success: function(data, status, xhr){
          success = true;
          var elapsed = new Date($.now()) - LOADING_START_TIME;
          setTimeout(
              function(){
                  params.successFunc(data, status, xhr);
                  $loading.hide(); 
              }, 1000 - elapsed
          );
      }
  }).always(function() {
      if(!success){
          var elapsed = new Date($.now()) - LOADING_START_TIME;
          setTimeout(
              function(){
                  params.successFunc(data, status, xhr);
                  $loading.hide(); 
              }, 1000 - elapsed
          );
      }
  })

}

$.fn.hasAncestor = function(a) {
    return $(this).closest(a).length >= 1 ? true : false;
};

$.fn.center = function() {
    var container = $(window);
    var top = -this.outerHeight() / 2;
    var left = -this.outerWidth() / 2;
    return this.css('position', 'fixed').css({
      'margin-left': left + 'px', 
      'margin-top': top + 'px', 
      'left': '50%', 'top': '50%'
    });
}
</script>
</html>