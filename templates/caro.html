<html>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!--<link rel="stylesheet" type="text/css" href="../static/main.css" />-->
        <script src="../static/lib/jquery-1.11.2.min.js"></script>
        <style>
            .caro {
                position:relative;
                overflow:auto;
            }
            .caro-window {
                position:relative;
                width:200px;
                height:200px;
                margin:100px 0 0 100px;
                overflow:hidden;
                border:1px solid #000;
            }
            .caro-stage {
                position:absolute;
                overflow:auto;
            }
            .caro-item {
                float:left;
                width:200px;
                height:200px;
                background-color:#bbb;
            }
            .caro-nav-prev {
                margin:0 10px 0 0;
            }
        </style>
    </head>

    <body>

        <h1>CAROUSEL TEST</h1>

        <div class='caro'>
            <div class='caro-window'>
                <div class='caro-stage'>
                    <div class='caro-item'><p>ITEM A</p></div>
                    <div class='caro-item'><p>ITEM B</p></div>
                    <div class='caro-item'><p>ITEM C</p></div>
                    <div class='caro-item'><p>ITEM D</p></div>
                </div>
            </div>
        </div>

    </body>

    <script type='text/javascript'>
        var caro = '';
        
        var CARO_INFO = {
            mousedown: false
        }; 

        function Caro(elem){
            
            var $caro = $(elem);
            var $caroWindow = $caro.find('.caro-window');
            var $stage = $caro.find('.caro-stage');

            var currentSlideNum = 1;
            var totalSlides = $caro.find('.caro-item').length;

            /* Set stage width */
            var itemWidthsTotal = 0;
            $caro.find('.caro-item').each(function() {
                itemWidthsTotal += $(this).outerWidth( true );
            });
            $stage.width(itemWidthsTotal);

            var nextSlide = function(){ 
                if(currentSlideNum < totalSlides){
                    moveSlide(-1);
                }
            };

            var prevSlide = function(){
                if(currentSlideNum > 1){
                    moveSlide(1);
                }
            };

            var moveSlide = function(vector){
                if(!$stage.hasClass('sliding')){
                    $stage.addClass('sliding');
                    $stage.animate(
                        { left: (vector < 0 ? '-=' : vector > 0 ? '+=' : '') 
                            + $caro.find('.caro-item').outerWidth() },
                        300, 
                        function(){ 
                            $stage.removeClass('sliding');
                        }
                    );
                    var step = -1 * vector;
                    currentSlideNum += step;
                }
            };

            var fixOvershoot = function(){
                /* If the stage was dragged beyond the first or last elements,
                animate back to boundary. */

                if($stage.offset().left > $caroWindow.offset().left){
                    if(!$stage.hasClass('sliding')){
                        $stage.addClass('sliding');
                        //Animate to the first slide
                        $stage.animate(
                            { left: 0 },
                            300, 
                            function(){ 
                                $stage.removeClass('sliding');
                            }
                        );
                    }
                }

                if($stage.offset().left + $stage.outerWidth() 
                    < $caroWindow.offset().left + $caroWindow.outerWidth()){
                    if(!$stage.hasClass('sliding')){
                        $stage.addClass('sliding');
                        //Animate to the last slide
                        $stage.animate({ 
                                left: "+=" + ( $caroWindow.offset().left 
                                - $caro.find('.caro-item:last').offset().left + 1) 
                            },
                            300, 
                            function(){ 
                                $stage.removeClass('sliding');
                            }
                        );
                    }
                }
            }

            var getTargetSlide = function(direction){
                
                var targetElem;

                if(direction < 0){ //Moving stage from right to left
                    
                    /* Find element where top left corner is inside window */
                    $caro.find('.caro-item').each( function( i, elem ) {
                        elem = $(elem);
                        if(elem.offset().left >= $caroWindow.offset().left
                            && elem.offset().left < ($caroWindow.offset().left + $caroWindow.outerWidth()) ){
                                targetElem = elem;
                                return false;
                        }
                    });

                }else if(direction > 0){ //Moving stage from left to right

                    /* Find element where top right corner is inside window */
                    $caro.find('.caro-item').each( function( i, elem ) {
                        elem = $(elem);
                        if(elem.position().left + elem.outerWidth() >= $caroWindow.position().left
                            && elem.position().left < ($caroWindow.position().left + $caroWindow.outerWidth()) ){
                                targetElem = elem;
                                return false;
                        }
                    });
                }

                return targetElem;
            }

            /* Setup the touch and drag events */
            $caroWindow.off('mousedown').on('mousedown', function(e){
                e.preventDefault();
                CARO_INFO.mousedown = true;
                CARO_INFO.startX = e.pageX;
                CARO_INFO.trackX = CARO_INFO.startX;
            });

            $caroWindow.off('mousemove').on('mousemove', function(e){
                if(CARO_INFO.mousedown){
                    
                    var newLeft = $stage.position().left + e.pageX - CARO_INFO.trackX;
                    var vector = e.pageX - CARO_INFO.startX;
                    var direction = 0;

                    if(vector != 0){
                        
                        var distance = Math.abs(vector);
                       
                        /* If distance >10px, slide all the way to the next or prev item */
                        if(distance > 10){
                            if(vector < 0) {
                                direction = -1; //Moving stage from right to left
                            }else if(vector > 0){
                                direction = 1; //Moving stage from left to right
                            }
                            /* Work out distance to target slide left position */
                            var targetSlide = getTargetSlide(direction);
                            if(targetSlide != null){
                                var moveX = e.pageX - targetSlide.position().left;
                                //TODO: snap animation to target slide
                            }
                        }

                        //Drag stage if still within bounds
                        if(direction == 1 && $stage.offset().left < $caroWindow.offset().left
                            || direction == -1 && $stage.offset().left + $stage.outerWidth() 
                            > $caroWindow.offset().left + $caroWindow.outerWidth()){
                            
                            $stage.css({ left: newLeft });
                            CARO_INFO.trackX = e.pageX;
                        }
                    }
                }
            });

            $caroWindow.off('mouseup').on('mouseup', function(e){ 
                CARO_INFO.mousedown = false; 
                fixOvershoot();
            });

            $caroWindow.off('mouseleave').on('mouseleave', function(e){ 
                if(CARO_INFO.mousedown == true){
                    CARO_INFO.mousedown = false;
                    fixOvershoot();
                } 
            });

            /* Add the nav controls */
            $caro.prepend('<a class="caro-nav-next" href="#">Next</a>');
            $caro.prepend('<a class="caro-nav-prev" href="#">Prev</a>');
            $caro.find('.caro-nav-prev').click(prevSlide);
            $caro.find('.caro-nav-next').click(nextSlide);

            return { caro: $caro, caroWindow: $caroWindow, stage: $stage };
        };
       
        $(document).ready(function() {
            caro = Caro('.caro');
        });
    </script>

</html>